{% set hub_location = parameters.DV_STORAGE_LOCATION %}

{{ stage('Create Link Table') }}

CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
(
    {% for col in columns %}
        {% set hub_table = "HUB_" + col.name | replace("_CAID", "") %}
        "{{ col.name }}" {{ col.dataType }} {% if col.is_Link_hk %} FOREIGN KEY REFERENCES {{ ref_no_link(hub_location, hub_table )}} ("{{ col.name }}" ){% endif %}
        {%- if not col.nullable %} NOT NULL
            {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
        {% endif %}
        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
        {%- if not loop.last -%}, {% endif %}
    {% endfor %}
)
{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
