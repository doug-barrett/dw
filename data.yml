defaultStorageMapping: DWH
installedPackages: {}
jobs:
  Job-5:
    excludeSelector: ""
    id: 5
    includeSelector: "+{ location: DWH name: FCT_* } "
    name: Process Fact Tables
    steps:
      - "58"
      - "1532"
    subgraphs: []
  Job-76:
    excludeSelector: ""
    id: 76
    includeSelector: "+{ location: DWH name: DIM_* }"
    name: Process Dimensions
    steps: []
    subgraphs: []
  Job-93:
    excludeSelector: "+{ location: DWH name: DIM_SUPPLIER }"
    id: 93
    includeSelector: "+{ location: DWH name: FCT_LINEITEM1 }"
    name: New Job
    steps: []
    subgraphs: []
locations:
  DWH:
    mappingDefinitions:
      "121":
        database: DOUG_DB
        schema: PROD_DWH
      "125":
        database: DOUG_DB
        schema: QA_DWH
  SRC_FIVETRAN_RETAIL:
    mappingDefinitions:
      "121":
        database: FIVETRAN_DATABASE
        schema: RETAIL_DATA
      "125":
        database: FIVETRAN_DATABASE
        schema: RETAIL_DATA
  SRC_SAMPLE:
    mappingDefinitions:
      "121":
        database: SNOWFLAKE_SAMPLE_DATA
        schema: TPCH_SF1
      "125":
        database: SNOWFLAKE_SAMPLE_DATA
        schema: TPCH_SF1
  SRC_WEATHER:
    mappingDefinitions:
      "121":
        database: COALESCE_SAMPLE_DATABASE
        schema: WEATHER
      "125":
        database: COALESCE_SAMPLE_DATABASE
        schema: WEATHER
  STAGE:
    mappingDefinitions:
      "121":
        database: DOUG_DB
        schema: PROD_STG
      "125":
        database: DOUG_DB
        schema: QA_STG
macros:
  Macro-1:
    id: "1"
    macroString: |+
      {%- macro row_number(order_by, partition_by=[], order='') -%}
          ROW_NUMBER() OVER (
              {%- for p_col in partition_by %}
                  {%- if loop.first %} PARTITION BY {% endif %}
                      {{- p_col -}}
                  {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              {%- for o_col in order_by -%}
                  {%- if loop.first %} ORDER BY {% endif -%}
                      {{- o_col -}}
                  {%- if not loop.last %}, {% endif -%}
              {%- endfor -%}
              {% if order != '' %} {{order}}{%- endif %} )
      {%- endmacro -%}



      {%- macro hash(columns, algo='MD5', delimiter='||', length=32) -%}
          {%  for column in columns %}
              {%- if loop.first %}CAST( {{ algo }}({% endif -%}
                  NVL(CAST({{ column }} AS VARCHAR), 'null')
              {%- if not loop.last %} || {% if delimiter != '' %} '{{ delimiter }}' || {% endif -%} {% endif -%}
              {%- if loop.last %}) AS CHAR({{ length }}) ){% endif -%}
          {%  endfor %}
      {%- endmacro -%}


      {%- macro even_odd(column) -%}
          CASE WHEN MOD({{ column }}, 2) = 0 THEN 'EVEN' ELSE 'ODD' END
      {%- endmacro %}


      {%- macro date_sk(column) -%}
          TO_NUMBER(TO_CHAR({{ column }}, 'YYYYMMDD'))
      {%- endmacro %}


      {%- macro replacer(column) -%}
          {% set ns = namespace(col=column) %}
          {% for p in parameters.replace %}
              {% set ns.col = ns.col | replace(p.long,  p.short) %}
          {% endfor %}
          {{ ns.col }}
      {%- endmacro %}


packages: {}
projects: {}
stepTypes:
  StepType-10:
    id: "10"
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |
        capitalized: Hub User-Defined
        short: 'HUB'
        plural: 'Hubs'

        tagColor: 'blue'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            options: 
            - table
            - view
            - HH
            default: table

          - displayName: Hub Hash Column
            type: columnSelector
            attributeName: isHubHash
            isRequired: true

          - type: multisourceToggle
          
        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |2
              {% if node.materializationType == 'table' %}
            				{{ stage('Create Hub Table') }}

            				CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}" {{ col.dataType }}
            						{%- if not col.nullable %} NOT NULL
            							{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            						{% endif %}
            						{%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
            						{%- if not loop.last -%}, {% endif %}
            					{% endfor %}
            				)
            				{%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}

            			{% endif %}
        run:
          templateString: |
            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}


            	{{ stage('Merge Hub') }}
            	MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
            	(
            		{% for source in sources %}
            		SELECT DISTINCT
            		{% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}

            		{{ source.join }}

            		{% if not loop.last %}
            			{{ config.insertStrategy }}
            		{% endif %}
            	{% endfor %}
            	)
            	AS "SRC"
            	ON
            	{% for col in sources[0].columns if (col.isHubHash) -%}
            		{% if not loop.first %}
            			AND
            		{% endif %}
            		"SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
            	{% endfor %}
            	WHEN NOT MATCHED THEN
            	INSERT
            	(
            		{% for col in columns %}
            			"{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	) VALUES
            	(
            		{% for col in columns %}
            			"SRC"."{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)


            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}

            {% endif %}
    name: Hub
    version: 1
  StepType-102:
    id: "102"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: INCREMENTAL
        short: INC
        plural: Incremental
        tagColor: green

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            default: view
            options:
            - view
            isRequired: true
            enableIf: "false"

          - displayName: Filter data based on Persistent Table
            attributeName: refTable
            type: toggleButton
            default: false
            isRequired: false

          - displayName: Persistent Table based on prefix
            attributeName: persistTable
            type: dropdownSelector
            default: ""
            options:
            - ""
            - "DS"
            - "DIM"
            - "FCT"
            - "SAT"
            - "PSTG"
            isRequired: false
            enableIf: "{{config.refTable}}"

          - displayName: Persistent Table location
            attributeName: persistTableLocation
            type: dropdownSelector
            default: "DWH"
            options:
            - "DWH"
            - "STAGE"
            isRequired: false
            enableIf: "{{config.refTable}}"

          - displayName: Persistent Table name if not selected above
            attributeName: persistTableName
            type: textBox
            default: ""
            isRequired: false
            enableIf: "{{config.refTable}}"
      templates:
        create:
          templateString: |
            {% set base = node.name | replace("INC", "") %}
            {% if config.persistTableName | length > 0 %}
                {% set persist = config.persistTableName %}
            {% else %}
                {% set persist = config.persistTable + base %}
            {% endif %}
            {% set source = sources[0] %}


            {{ stage('Create Stage View') }}

            CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns if col.name != "_SEQUENCE" %}
                    "{{ col.name }}"
                    {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                    {% if not loop.last %}, {% endif %}
                {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            AS
            SELECT
            {% for col in source.columns  %}
                {{ get_source_transform(col) }} AS  "{{ col.name }}" 
                {%- if not loop.last -%}, {% endif %} 
            {% endfor %}

            {{ source.join }}

            {% if config.refTable and persist | length > 0  %}
                {% if "WHERE" in source.join | upper %}
                    AND
                {% else %}
                    WHERE 
                {% endif %}
                _FIVETRAN_SYNCED > (SELECT NVL(MAX(_FIVETRAN_SYNCED), '1900-01-01') 
                                    FROM {{ref(config.persistTableLocation, persist)}} )
            {% endif %}
        run:
          templateString: ""
    name: Fivetran Incremental
    version: 1
  StepType-11:
    id: "11"
    isDisabled: true
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |
        capitalized: Link User-Defined
        short: 'LNK'
        plural: 'Links'
        tagColor: 'red'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table

          - displayName: Insert Strategy
            attributeName: insertStrategy
            type: dropdownSelector
            default: UNION
            options:
            - "UNION"
            - "UNION ALL"
            isRequired: true
          
          - displayName: Link Hash Column
            type: columnSelector
            attributeName: isLinkHash
            isRequired: true

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |
            {% if node.materializationType == 'table' %}
                           {{ stage('Create Link Table') }}
             
                           CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
                           (
                               {% for col in columns %}
                                   "{{ col.name }}" {{ col.dataType }}
                                   {%- if not col.nullable %} NOT NULL
                                       {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                                   {% endif %}
                                   {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                                   {%- if not loop.last -%}, {% endif %}
                               {% endfor %}
                           )
                           {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
             
                       {% endif %}
        run:
          templateString: |
            {% if node.materializationType == 'table' %}
               {% if config.preSQL %}
                   {{ stage('Pre-SQL') }}
                   {{ config.preSQL }}
              
               {% endif %}
             
                      
               {{ stage('Merge Link') }}
               MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
               (
                   {% for source in sources %}
                   SELECT
                   {% for col in source.columns %}
                       {{ get_source_transform(col) }} AS "{{ col.name }}"
                       {%- if not loop.last -%}, {% endif %}
                   {% endfor %}
             
                   {{ source.join }}
             
                   {% if not loop.last %}
                       {{ config.insertStrategy }}
                   {% endif %}
               {% endfor %}
               )
               AS "SRC"
               ON
               {% for col in sources[0].columns if (col.isLinkHash) -%}
                   {% if not loop.first %}
                       AND
                   {% endif %}
                   "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
               {% endfor %}
               WHEN NOT MATCHED THEN
               INSERT
               (
                   {% for col in columns %}
                       "{{ col.name }}"
                       {%- if not loop.last -%}, {% endif %}
                   {% endfor %}
               ) VALUES
               (
                   {% for col in columns %}
                       "SRC"."{{ col.name }}"
                       {%- if not loop.last -%}, {% endif %}
                   {% endfor %}
               )
             
               {% if config.postSQL %}
                   {{ stage('Post-SQL') }}
                   {{ config.postSQL }}   
               {% endif %}
            {% endif %}
    name: Link
    version: 1
  StepType-12:
    id: "12"
    isDisabled: true
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |-
        capitalized: Copy of Effectivity Satellite User-Defined
        short: 'EFF_SAT'
        plural: 'Satellites'
        tagColor: 'yellow'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table

         
          - displayName: Link Hash Column
            type: columnSelector
            attributeName: isLinkHash
            isRequired: true

          - displayName: Driving Key Column
            type: columnSelector
            attributeName: isDrivingKey
            isRequired: true


        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |2-
              {% if node.materializationType == 'table' %}
            				{{ stage('Create Effectivity Satellite Table') }}

            				CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}" {{ col.dataType }}
            						{%- if not col.nullable %} NOT NULL
            							{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            						{% endif %}
            						{%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
            						{%- if not loop.last -%}, {% endif %}
            					{% endfor %}
            				)
            				{%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}

            			{% endif %}
        run:
          templateString: |-
            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}

            	{{ stage('Insert New Rows') }}
            	INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            	WITH "SAT_CURR_ROWS" AS (
            		/* get current rows from satellite */
            		{% for col in columns if col.isDrivingKey or col.isLinkHash %}
            			{%- if loop.first -%}SELECT {% endif %} 
            			{{col.name}}
            			{%- if not loop.last -%}, {% endif %}
            			{%- if loop.last %} 
            				FROM {{ ref_no_link(node.location.name, node.name) }} 
            				QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ get_value_by_column_attribute("isDrivingKey") }}" ORDER BY "{{ get_value_by_column_attribute("isSystemCreateDate") }}" DESC) = 1
            			{% endif %}
            		{% endfor %}
            	)

            		{% for source in sources %}
            			SELECT DISTINCT
            			{% for col in source.columns %}
            				{{ get_source_transform(col) }} AS "{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}

            			{{ source.join }}
            		WHERE NOT EXISTS(
            			SELECT 1 FROM "SAT_CURR_ROWS"
            			WHERE 
            			{% for col in source.columns if col.isDrivingKey or col.isLinkHash %}
            				{% if not loop.first %}
            					AND
            				{% endif %}
            				{{ get_source_transform(col) }} = "SAT_CURR_ROWS"."{{ col.name }}"
            			{% endfor %}
            		)

            		{% endfor %}

            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}

            {% endif %}
    name: Satellite - Effectivity
    version: 1
  StepType-120:
    id: "120"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Stage View
        short: VSTG
        tagColor: '#C4C4C4'
        isDisabled: true
        plural: Views

        config:
          - groupName: Options
            items: 
            - type: materializationSelector
              options:
                - view
              default: view
              isRequired: true

            - type: toggleButton
              attributeName: selectDistinct
              displayName: Distinct

            - type: multisourceToggle

            - type: overrideSQLToggle

            - displayName: Multi Source Strategy
              attributeName: insertStrategy
              type: dropdownSelector
              default: UNION
              options:
              - "UNION"
              - "UNION ALL" 
              isRequired: true
              enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"
      templates:
        create:
          templateString: |
            {% if node.override.create.enabled %}
                
                {{ node.override.create.script }}

            {% else %}
                {{ stage('Create View') }}
                CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}"
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                AS
                {% for source in sources %}
                    SELECT {% if config.selectDistinct %} DISTINCT {% endif %}
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}

                    {% if not loop.last %}
                        {% if config.insertStrategy in ['UNION', 'UNION ALL'] %}
                            {{ config.insertStrategy }}
                        {% else %}
                            UNION
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        run:
          templateString: ""
    name: Stage View
    version: 1
  StepType-13:
    id: "13"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: SNAPSHOT V0'
        short: 'SNAPSHOTV0'
        plural: 'DATAVAULT BY SCALEFREE: SNAPSHOTS V0'
        tagColor: '#1E8449'

        config:
        - groupName: Data Vault
          items:
          - displayName: Snapshot Start Date (yyyy-mm-dd)
            type: textBox
            attributeName: input_snapshot_start_date
            isRequired: true
            default: "2020-01-01"

          - displayName: Snapshot End Date (yyyy-mm-dd)
            type: textBox
            attributeName: input_snapshot_end_date
            isRequired: true
            default: "2025-12-31"

          - displayName: Daily Snapshot Time (hh:mm:ss)
            type: textBox
            attributeName: input_daily_snapshot_time
            isRequired: true
            default: "07:00:00"

          - type: materializationSelector
            default: table
            options:
            - table
            isRequired: true
            enableIf: "false" 

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true    

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false


        systemColumns:
        - displayName: "SDTS"
          transform: ""
          dataType: TIMESTAMP
          placement: end
          attributeName: system_sdts

        - displayName: "FORCE_ACTIVE"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_force_active

        - displayName: "REPLACEMENT_SDTS"
          transform: ""
          dataType: TIMESTAMP
          placement: end
          attributeName: system_replacement_sdts

        - displayName: "CAPTION"
          transform: ""
          dataType: STRING
          placement: end
          attributeName: system_caption

        - displayName: "IS_HOURLY"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_hourly

        - displayName: "IS_DAILY"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_daily

        - displayName: "IS_BEGINNING_OF_WEEK"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_beginning_of_week

        - displayName: "IS_BEGINNING_OF_MONTH"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_beginning_of_month

        - displayName: "IS_BEGINNING_OF_QUARTER"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_beginning_of_quarter

        - displayName: "IS_BEGINNING_OF_YEAR"
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_beginning_of_year
      templates:
        create:
          templateString: |-
            {{ stage('Create Snapshot v0 Table') }}

              CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
              (
                {% for col in columns %}
                  "{{ col.name }}" {{ col.dataType }}
                  {%- if not col.nullable %} NOT NULL
                    {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                  {% endif %}
                  {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                  {%- if not loop.last -%}, {% endif %}
                {% endfor %}
              )
              {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% for test in node.tests if config.testsEnabled %}
              {% if test.runOrder == 'Before' %}
                {{ test_stage(test.name, test.continueOnFailure) }}
                {{ test.templateString }}
              {% endif %}
            {% endfor %}

            {{ stage('Insert New Rows') }}

            {%- set timestamp_format = datavault4coalesce.config.timestamp_format -%}
            {%- set start_date = config.input_snapshot_start_date -%}
            {%- set end_date = config.input_snapshot_end_date -%}
            {%- set daily_snapshot_time = config.input_daily_snapshot_time -%}

            INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH "date_base" AS (
                SELECT
                    "sdts" as "{{ datavault4coalesce.config.sdts_alias }}",
                    TRUE as "force_active",
                    "sdts" AS "replacement_sdts",
                    CONCAT('Snapshot ', DATE("sdts")) AS "caption",
                    CASE
                        WHEN EXTRACT(MINUTE FROM "sdts") = 0 AND EXTRACT(SECOND FROM "sdts") = 0 THEN TRUE
                        ELSE FALSE
                    END AS "is_hourly",
                    CASE
                        WHEN EXTRACT(HOUR FROM "sdts") = 0 AND EXTRACT(MINUTE FROM "sdts") = 0 AND EXTRACT(SECOND FROM "sdts") = 0 THEN TRUE
                        ELSE FALSE
                    END AS "is_daily",
                    CASE
                        WHEN EXTRACT(DAYOFWEEK FROM  "sdts") = 1 THEN TRUE
                        ELSE FALSE
                    END AS "is_beginning_of_week",
                    CASE
                        WHEN EXTRACT(DAY FROM "sdts") = 1 THEN TRUE
                        ELSE FALSE
                    END AS "is_beginning_of_month",
                    CASE
                        WHEN EXTRACT(DAY FROM "sdts") = 1 AND EXTRACT(MONTH FROM "sdts") in (1, 4, 7, 10) THEN TRUE
                        ELSE FALSE
                    END AS "is_beginning_of_quarter",  
                    CASE
                        WHEN EXTRACT(DAY FROM "sdts") = 1 AND EXTRACT(MONTH FROM "sdts") = 1 THEN TRUE
                        ELSE FALSE
                    END AS "is_beginning_of_year"
                FROM 
                (
                    SELECT
                        DATEADD(DAY, SEQ4(), 
                        TIMESTAMPADD(SECOND, EXTRACT(SECOND FROM TO_TIME('{{ daily_snapshot_time }}')), 
                        TIMESTAMPADD(MINUTE, EXTRACT(MINUTE FROM TO_TIME('{{ daily_snapshot_time }}')), 
                        TIMESTAMPADD(HOUR, EXTRACT(HOUR FROM TO_TIME('{{ daily_snapshot_time }}')), TO_DATE('{{ start_date }}', 'YYYY-MM-DD')))
                        ))::TIMESTAMP AS "sdts"
                    FROM 
                        TABLE(GENERATOR(ROWCOUNT => 100000))
                    WHERE 
                        "sdts" <= TO_DATE('{{ end_date }}', 'YYYY-MM-DD')
                ) 
            ),

            "records_to_insert" AS (

                SELECT 
                    "date_base".*
                FROM "date_base"
                LEFT JOIN {{ ref_no_link(node.location.name, node.name) }} "tgt"
                    ON "date_base"."{{ datavault4coalesce.config.sdts_alias }}" = "tgt"."{{ datavault4coalesce.config.sdts_alias }}"
                WHERE "tgt"."{{ datavault4coalesce.config.sdts_alias }}" IS NULL

            )

            SELECT * FROM "records_to_insert"

            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}

            {% if config.testsEnabled %}
              {% for test in node.tests %}
                {% if test.runOrder == 'After' %}
                  {{ test_stage(test.name, test.continueOnFailure) }}
                  {{ test.templateString }}
                    {% endif %}
              {% endfor %}

              {% for column in columns %}
                {% for test in column.tests %}
                  {{ test_stage(column.name + ": " + test.name) }}
                  {{ test.templateString }}
                {% endfor %}
              {% endfor %}
            {% endif %}
    name: "Datavault by Scalefree: Snapshot v0"
    version: 1
  StepType-14:
    id: "14"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: SNAPSHOT V1'
        short: 'SNAPSHOTV1'
        plural: 'DATAVAULT BY SCALEFREE: SNAPSHOTS V1'
        tagColor: '#58D68D'

        config:

        - groupName: Use Logarithmic Logic
          items:
          - displayName: Use Logarithmic Logic
            type: toggleButton
            attributeName: use_logarithmic_logic
            enableIf: 'true'
            isRequired: true
            default: true
          - type: materializationSelector
            default: view
            options:
            - view
            isRequired: true
            enableIf: "false"   

        - groupName: Daily Snapshot Logic
          enableIf: "{{ config.use_logarithmic_logic }}"
          items:
          - displayName: Keep Daily Snapshots forever
            type: toggleButton
            attributeName: daily_snapshots_forever
            enableIf: "{{ config.use_logarithmic_logic }}"
            isRequired: true
            default: false

          - displayName: Duration
            type: textBox
            attributeName: daily_snapshot_duration
            enableIf: "{% if not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: "30"

          - displayName: Time Unit
            type: dropdownSelector
            attributeName: daily_snapshot_unit
            enableIf: "{% if not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: DAY
            options:
            - DAY
            - WEEK
            - MONTH
            - QUARTER
            - YEAR
            
        - groupName: Weekly Snapshot Logic
          enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
          items:
          - displayName: Keep Weekly Snapshots forever
            type: toggleButton
            attributeName: weekly_snapshots_forever
            enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: false

          - displayName: Duration
            type: textBox
            attributeName: weekly_snapshot_duration
            enableIf: "{% if not config.weekly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: "1"

          - displayName: Time Unit
            type: dropdownSelector
            attributeName: weekly_snapshot_unit
            enableIf: "{% if not config.weekly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}" 
            isRequired: true
            default: "YEAR"
            options:
            - DAY
            - WEEK
            - MONTH
            - QUARTER
            - YEAR   

        - groupName: Monthly Snapshot Logic
          enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
          items:
          - displayName: Keep Monthly Snapshots forever
            type: toggleButton
            attributeName: monthly_snapshots_forever
            enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: false

          - displayName: Duration
            type: textBox
            attributeName: monthly_snapshot_duration
            enableIf: "{% if not config.monthly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: "3"

          - displayName: Time Unit
            type: dropdownSelector
            attributeName: monthly_snapshot_unit
            enableIf: "{% if not config.monthly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: YEAR
            options:
            - DAY
            - WEEK
            - MONTH
            - QUARTER
            - YEAR

        - groupName: Quarterly Snapshot Logic
          enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever and not config.monthly_snapshots_forever %} true {% else %} false {% endif %}"
          items:
          - displayName: Keep Quarterly Snapshots forever
            type: toggleButton
            attributeName: quarterly_snapshots_forever
            enableIf: "{% if config.use_logarithmic_logic and not config.daily_snapshots_forever and not config.monthly_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: false

          - displayName: Duration
            type: textBox
            attributeName: quarterly_snapshot_duration
            enableIf: "{% if not config.quarterly_snapshots_forever and not config.daily_snapshots_forever and not config.monthly_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: "5"

          - displayName: Time Unit
            type: dropdownSelector
            attributeName: quarterly_snapshot_unit
            enableIf: "{% if not config.quarterly_snapshots_forever and not config.daily_snapshots_forever and not config.monthly_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: YEAR
            options:
            - DAY
            - WEEK
            - MONTH
            - QUARTER
            - YEAR
            
        - groupName: Yearly Snapshot Logic
          enableIf: "{% if config.use_logarithmic_logic and not config.quarterly_snapshots_forever and not config.monthly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
          items:
          - displayName: Keep Yearly Snapshots forever
            type: toggleButton
            attributeName: yearly_snapshots_forever
            enableIf: "{% if config.use_logarithmic_logic and not config.quarterly_snapshots_forever and not config.monthly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: false

          - displayName: Duration
            type: textBox
            attributeName: yearly_snapshot_duration
            enableIf: "{% if not config.yearly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}"
            isRequired: true
            default: "10"

          - displayName: Time Unit
            type: dropdownSelector
            attributeName: yearly_snapshot_unit
            enableIf: "{% if not config.yearly_snapshots_forever and not config.daily_snapshots_forever %} true {% else %} false {% endif %}" 
            isRequired: true
            default: YEAR
            options:
            - DAY
            - WEEK
            - MONTH
            - QUARTER
            - YEAR  

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false


        systemColumns:
        - displayName: IS_ACTIVE
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_active

        - displayName: IS_LATEST
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_latest

        - displayName: IS_CURRENT_YEAR
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_current_year

        - displayName: IS_LAST_YEAR
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_last_year

        - displayName: IS_ROLLING_YEAR
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_rolling_year

        - displayName: IS_LAST_ROLLING_YEAR
          transform: ""
          dataType: BOOLEAN
          placement: end
          attributeName: system_is_last_rolling_year
      templates:
        create:
          templateString: |-
            {{ stage('Create Snapshot v1 View') }}

            {% if config.use_logarithmic_logic %}
                {%-set log_logic = {
                'daily':        {'duration': config.daily_snapshot_duration|int,
                                'unit': '{{config.daily_snapshot_unit}}',
                                'forever': '{{config.daily_snapshots_forever}}'},
                'weekly':       {'duration': config.weekly_snapshot_duration|int,
                                'unit': '{{config.weekly_snapshot_unit}}',
                                'forever': '{{config.weekly_snapshots_forever}}'},
                'monthly':      {'duration': config.monthly_snapshot_duration|int,
                                'unit': '{{config.monthly_snapshot_unit}}',
                                'forever': '{{config.monthly_snapshots_forever}}'},
                'quarterly':    {'duration': config.quarterly_snapshot_duration|int,
                                'unit': '{{config.quarterly_snapshot_unit}}',
                                'forever': '{{config.quarterly_snapshots_forever}}'},
                'yearly':       {'duration': config.yearly_snapshot_duration|int,
                                'unit': '{{config.yearly_snapshot_unit}}',
                                'forever': '{{config.yearly_snapshots_forever}}'},
                    } 
                %}
            {% else %}
                {% set log_logic = none %}
            {% endif %}

            {% set sdts_alias = datavault4coalesce.config.sdts_alias %}
            {% set ns = namespace(forever_status=FALSE) %}
            {% set snapshot_trigger_column = 'IS_ACTIVE' %}


            CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                "{{ col.name }}"
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
              {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}

            AS
            WITH latest_row AS (

                SELECT
                    "{{ sdts_alias }}"
                FROM {{ ref(sources[0].columns[0].sourceColumns[0].node.location.name, sources[0].columns[0].sourceColumns[0].node.name) }}
                WHERE "{{ sdts_alias }}" <= SYSDATE()
                ORDER BY "{{ sdts_alias }}" DESC
                LIMIT 1

            ), 

            virtual_logic AS (
                
                SELECT
                    c."{{ sdts_alias }}",
                    c."REPLACEMENT_SDTS",
                    c."FORCE_ACTIVE",
                    {%- if log_logic is none %}
                    TRUE AS {{ snapshot_trigger_column }},
                    {%- else %}
                    CASE 
                        WHEN
                        {% if 'daily' in log_logic.keys() %}
                            {%- if log_logic['daily']['forever'] is true -%}
                                {%- set ns.forever_status = 'TRUE' -%}
                              (1=1)
                            {%- else %}
                                {%- set daily_duration = log_logic['daily']['duration'] -%}
                                {%- set daily_unit = log_logic['daily']['unit'] -%}
                              (DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN SYSDATE() - INTERVAL '{{ daily_duration }} {{ daily_unit }}' AND SYSDATE())
                            {%- endif -%}   
                        {%- endif %}

                        {%- if 'weekly' in log_logic.keys() %} OR 
                            {%- if log_logic['weekly']['forever'] is true -%}
                                {%- set ns.forever_status = 'TRUE' -%}
                          (c."IS_BEGINNING_OF_WEEK" = TRUE)
                            {%- else %} 
                                {%- set weekly_duration = log_logic['weekly']['duration'] -%}
                                {%- set weekly_unit = log_logic['weekly']['unit'] %}            
                          ((DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN SYSDATE() - INTERVAL '{{ weekly_duration }} {{ weekly_unit }}' AND SYSDATE()) AND (c."IS_BEGINNING_OF_WEEK" = TRUE))
                            {%- endif -%}
                        {% endif -%}

                        {%- if 'monthly' in log_logic.keys() %} OR
                            {%- if log_logic['monthly']['forever'] is true -%}
                                {%- set ns.forever_status = 'TRUE' %}
                          (c."IS_BEGINNING_OF_MONTH" = TRUE)
                            {%- else %}
                                {%- set monthly_duration = log_logic['monthly']['duration'] -%}
                                {%- set monthly_unit = log_logic['monthly']['unit'] %}            
                          ((DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN SYSDATE() - INTERVAL '{{ monthly_duration }} {{ monthly_unit }}' AND SYSDATE()) AND (c."IS_BEGINNING_OF_MONTH" = TRUE))
                            {%- endif -%}
                        {% endif -%}

                        {%- if 'quarterly' in log_logic.keys() %} OR
                            {%- if log_logic['quarterly']['forever'] is true -%}
                                {%- set ns.forever_status = 'TRUE' %}
                          (c."IS_BEGINNING_OF_QUARTER" = TRUE)
                            {%- else %}
                                {%- set quarterly_duration = log_logic['quarterly']['duration'] -%}
                                {%- set quarterly_unit = log_logic['quarterly']['unit'] %}            
                          ((DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN SYSDATE() - INTERVAL '{{ quarterly_duration }} {{ quarterly_unit }}' AND SYSDATE()) AND (c."IS_BEGINNING_OF_QUARTER" = TRUE))
                            {%- endif -%}
                        {% endif -%}

                        {%- if 'yearly' in log_logic.keys() %} OR 
                            {%- if log_logic['yearly']['forever'] is true -%}
                                {%- set ns.forever_status = 'TRUE' %}
                          (c."IS_BEGINNING_OF_YEAR" = TRUE)
                            {%- else %}
                                {%- set yearly_duration = log_logic['yearly']['duration'] -%}
                                {%- set yearly_unit = log_logic['yearly']['unit'] %}                    
                          ((DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN SYSDATE() - INTERVAL '{{ yearly_duration }} {{ yearly_unit }}' AND SYSDATE()) AND (c."IS_BEGINNING_OF_YEAR" = TRUE))
                            {%- endif -%}
                        {% endif %}
                        THEN TRUE
                        ELSE FALSE
                    END AS {{ snapshot_trigger_column }},
                    {%- endif %}

                    CASE
                        WHEN l."{{ sdts_alias }}" IS NULL THEN FALSE
                        ELSE TRUE
                    END AS "IS_LATEST",

                    c."CAPTION",
                    c."IS_HOURLY",
                    c."IS_DAILY",
                    c."IS_BEGINNING_OF_WEEK",
                    c."IS_BEGINNING_OF_MONTH",
                    c."IS_BEGINNING_OF_QUARTER",
                    c."IS_BEGINNING_OF_YEAR",
                    CASE
                        WHEN EXTRACT(YEAR FROM c."{{ sdts_alias }}") = EXTRACT(YEAR FROM SYSDATE()) THEN TRUE
                        ELSE FALSE
                    END AS "IS_CURRENT_YEAR",
                    CASE
                        WHEN EXTRACT(YEAR FROM c."{{ sdts_alias }}") = EXTRACT(YEAR FROM SYSDATE())-1 THEN TRUE
                        ELSE FALSE
                    END AS "IS_LAST_YEAR",
                    CASE
                        WHEN DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN (SYSDATE() - INTERVAL '1 YEAR') AND SYSDATE() THEN TRUE
                        ELSE FALSE
                    END AS "IS_ROLLING_YEAR",
                    CASE
                        WHEN DATE_TRUNC('DAY', c."{{ sdts_alias }}"::DATE) BETWEEN (SYSDATE() - INTERVAL '2 YEAR') AND (SYSDATE() - INTERVAL '1 YEAR') THEN TRUE
                        ELSE FALSE
                    END AS "IS_LAST_ROLLING_YEAR"
                FROM {{ ref(sources[0].columns[0].sourceColumns[0].node.location.name, sources[0].columns[0].sourceColumns[0].node.name) }} c
                LEFT JOIN latest_row l
                ON c."{{ sdts_alias }}" = l."{{ sdts_alias }}"
                WHERE c."{{ sdts_alias }}" < SYSDATE()
            ),

            active_logic_combined AS (

                SELECT 
                    "{{ sdts_alias }}",
                    "FORCE_ACTIVE",
                    "REPLACEMENT_SDTS",
                    "CAPTION",
                    "IS_HOURLY",
                    "IS_DAILY",
                    "IS_BEGINNING_OF_WEEK",
                    "IS_BEGINNING_OF_MONTH",
                    "IS_BEGINNING_OF_QUARTER",
                    "IS_BEGINNING_OF_YEAR",
                    CASE
                        WHEN "FORCE_ACTIVE" AND {{ snapshot_trigger_column }} THEN TRUE
                        WHEN NOT "FORCE_ACTIVE" OR NOT {{ snapshot_trigger_column }} THEN FALSE
                    END AS "{{ snapshot_trigger_column }}",
                    "IS_LATEST",         
                    "IS_CURRENT_YEAR",
                    "IS_LAST_YEAR",
                    "IS_ROLLING_YEAR",
                    "IS_LAST_ROLLING_YEAR"
                FROM virtual_logic
                ORDER BY "{{ sdts_alias }}" DESC
            )

            SELECT * FROM active_logic_combined
        run:
          templateString: ""
    name: "Datavault by Scalefree: Snapshot v1"
    version: 1
  StepType-144:
    id: "144"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Stream
        short: STR
        tagColor: "yellow"
        plural: Streams

        deployStrategy: advanced

        config:

        - groupName: Stream
          items:

          - displayName: Source type
            attributeName: srcType
            type: dropdownSelector
            default: "TABLE"
            options:
            - "TABLE"
            - "VIEW"
            - "EXTERNAL TABLE"
            - "STAGE"
            isRequired: true

          - displayName: Initial Rows
            attributeName: initialRows
            type: toggleButton
            default: true
            isRequired: false
            enableIf: "{{ config.srcType == 'TABLE' or config.srcType == 'VIEW' }}"

          - displayName: Append Only
            attributeName: appendOnly
            type: toggleButton
            default: false
            isRequired: false
            enableIf: "{{ config.srcType == 'TABLE' or config.srcType == 'VIEW' }}"

          - displayName: Type
            type: materializationSelector
            default: view
            options:
            - view
            isRequired: true
            enableIf: "false"

        systemColumns:
        - displayName: "METADATA$ACTION"
          transform: "METADATA$ACTION"
          dataType: STRING
          placement: end
          attributeName: isStreamMetadataAction
          description: Indicates the DML operation (INSERT, DELETE) recorded.
        - displayName: "METADATA$ISUPDATE"
          transform: "METADATA$ISUPDATE"
          dataType: STRING
          placement: end
          attributeName: isStreamMetadataIsUpdate
          description: Indicates whether the operation was part of an UPDATE statement.
        - displayName: "METADATA$ROW_ID"
          transform: "METADATA$ROW_ID"
          dataType: STRING
          placement: end
          attributeName: isStreamMetadataRowId
          description: Specifies the unique and immutable ID for the row, which can be used to track changes to specific rows over time.
      templates:
        create:
          templateString: |-
            {% if desiredState == undefined %}

              {{ stage('Drop Stream') }}
              DROP STREAM IF EXISTS {{ ref_no_link(currentState.node.location.name, currentState.node.name) }}

            {% elif currentState == undefined %}

              {{ stage('Create Stream') }}
              CREATE OR REPLACE STREAM  {{ ref_no_link(desiredState.node.location.name, desiredState.node.name )  }}
              ON {{desiredState.config.srcType}} {{ ref(desiredState.sources[0].dependencies[0].node.location.name, desiredState.sources[0].dependencies[0].node.name) }}
              {% if desiredState.config.srcType == 'TABLE' or desiredState.config.srcType == 'VIEW' %}
              APPEND_ONLY = {% if desiredState.config.appendOnly is true %} TRUE {%- else -%} FALSE {% endif %} 
              SHOW_INITIAL_ROWS = {% if desiredState.config.initialRows is true %} TRUE {%- else -%} FALSE {% endif %} 
              {% elif desiredState.config.srcType == 'EXTERNAL TABLE' %}
              INSERT_ONLY = TRUE
              {% endif %}

              COMMENT = 'CDC Stream on {{ this }}'

            {% endif %}
        run:
          templateString: ""
    name: Stream
    version: 1
  StepType-16:
    id: "16"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: External Table
        short: 'EXT'
        tagColor: '#C39BD3'
        isDisabled: false
        plural: External Tables

        deployStrategy: advanced

        config:
        - groupName: File Location
          items: 

          - displayName: Snowflake Stage
            attributeName: fileLocation
            type: textBox
            default: "<DB>.<SCH>.<STAGE>/<FOLDER>"
            isRequired: true

          - displayName: File Pattern
            attributeName: filePattern
            type: textBox
            default: ".*[.]json"
            isRequired: true

        - groupName: File Format 
          items:

          - displayName: File Type
            attributeName: fileType
            type: dropdownSelector
            default: JSON
            options:
            - "CSV"
            - "JSON"
            - "Parquet"
            - "XML"
            isRequired: true

          - displayName: Compression
            attributeName: compression
            enableIf: "{{ config.fileType in ['CSV','JSON'] }}" 
            type: dropdownSelector
            options:
            - "AUTO"
            - "GZIP"
            - "BZ2"
            - "BROTLI"
            - "ZSTD"
            - "DEFLATE"
            - "RAW_DEFLATE"
            - "NONE"
            isRequired: false

          - displayName: Record delimiter
            attributeName: recDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\n"
            isRequired: false

          - displayName: Field delimiter
            attributeName: fieldDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: ","
            isRequired: false

          - displayName: Field optionally enclosed by
            attributeName: fieldEnclosed
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\\042"
            isRequired: false

          - displayName: Number of header lines to skip
            attributeName: skipHeader
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "1"
            isRequired: false

          - displayName: Skip blank lines
            attributeName: skipBlankLines
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

          - displayName: Trim space
            attributeName: trimSpace
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

        - groupName: Additional Options
          items:
          - displayName: Auto Refresh
            attributeName: autoRefresh
            type: toggleButton
            default: false
            isRequired: false

          - displayName: AWS SNS Topic
            attributeName: snsTopic
            type: textBox
            enableIf: "{{ config.autoRefresh }}"
            default: "arn:aws:sns:us-east-1:121674918127:prod-emea-s3-notification"
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            isRequired: true

        systemColumns:

        - displayName: 'VALUE'
          attributeName: 'VALUE'
          transform: ''
          dataType: VARIANT
          placement: beginning
        - displayName: 'METADATA$FILENAME'
          attributeName: 'METADATA$FILENAME'
          transform: ''
          dataType: STRING
          placement: end
      templates:
        create:
          templateString: |-
            {% if desiredState is undefined %}
              {{ stage('Drop External Table') }}
              DROP EXTERNAL TABLE IF EXISTS {{ ref_no_link(currentState.node.location.name, currentState.node.name) }}

            {% else %}

            {{ stage('Create External Table') }}

            CREATE OR REPLACE EXTERNAL TABLE {{ ref_no_link(desiredState.node.location.name, desiredState.node.name) }}
              {% if desiredState.config.fileType == "CSV" %}
                {% for col in desiredState.sources[0].columns if (col.name | upper != "VALUE" and col.name | upper != "METADATA$FILENAME") %}
                  {% if loop.first %}({% endif %}
                    "{{ col.name }}" {{ col.dataType }} AS (value:c{{ loop.index }}::{{ col.dataType }})
                  {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                  {%- if not loop.last -%}, {% else %}){% endif %}
                {% endfor %}
              {% endif %}
              
              with location = @{{desiredState.config.fileLocation}}
              pattern='{{ desiredState.config.filePattern }}'
              file_format = (type = {{ desiredState.config.fileType }}
              {% if desiredState.config.fileType == "CSV" %}
                {% if desiredState.config.recDelim != null %}record_delimiter = '{{ desiredState.config.recDelim }}'{% endif %}
                {% if desiredState.config.fieldDelim != null %}field_delimiter = '{{ desiredState.config.fieldDelim }}'{% endif %}
                {% if desiredState.config.fieldEnclosed != null %}field_optionally_enclosed_by = '{{ desiredState.config.fieldEnclosed }}'{% endif %}
                {% if desiredState.config.skipHeader != null %}skip_header = {{ desiredState.config.skipHeader }}{% endif %}
                {% if desiredState.config.skipBlankLines %}skip_blank_lines = {{ desiredState.config.skipBlankLines }}{% endif %}
                {% if desiredState.config.trimSpace %}trim_space = {{ desiredState.config.trimSpace }}{% endif %}
              {% endif %}
              )
              auto_refresh = {{ desiredState.config.autoRefresh }}
              {% if desiredState.config.autoRefresh and desiredState.config.snsTopic != null %}aws_sns_topic = '{{ desiredState.config.snsTopic }}'{% endif %}
              {%- if desiredState.node.description | length > 0 %} COMMENT = '{{ desiredState.node.description }}'{% endif %}
            ;
            {% endif %}
        run:
          templateString: |-
            {% if config.autoRefresh is false %}
            {{ stage('Refresh External Table') }}
            ALTER EXTERNAL TABLE {{ ref_no_link(node.location.name, node.name) }} REFRESH
            {% endif %}
    name: External Table
    version: 1
  StepType-166:
    id: "166"
    isDisabled: true
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |-
        capitalized: Copy of Dimension
        short: DIM
        tagColor: '#1E339A'
        plural: Dimensions

        config:
        - groupName: Options
          items:

          - type: businessKeyColumns
            isRequired: true

        - groupName: Advanced Options
          items:

          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            - view
            isRequired: false

          - type: multisourceToggle
            enableIf: "{% if node.materializationType == 'table' %} true {% else %} false {% endif %}"

          - type: changeTrackingColumns
            isRequired: false

          - type: toggleButton
            attributeName: insertZeroKey
            displayName: Insert Zero Key Record
            default: true

          - type: overrideSQLToggle
            enableIf: "{% if node.materializationType == 'view' %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: '{{NODE_NAME}}_KEY'
          transform: ''
          dataType: NUMBER
          placement: beginning
          attributeName: isSurrogateKey

        - displayName: SYSTEM_VERSION
          transform: ''
          dataType: NUMBER
          placement: end
          attributeName: isSystemVersion

        - displayName: SYSTEM_CURRENT_FLAG
          transform: ''
          dataType: VARCHAR
          placement: end
          attributeName: isSystemCurrentFlag

        - displayName: SYSTEM_START_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemStartDate

        - displayName: SYSTEM_END_DATE
          transform: CAST('2999-12-31 00:00:00' AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemEndDate

        - displayName: SYSTEM_CREATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: SYSTEM_UPDATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemUpdateDate
      templates:
        create:
          templateString: |
            {% if node.materializationType == 'table' %}
            	{{ stage('Create Dimension Table') }}

            	CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}" {{ col.dataType }} 
            			{% if col.isSurrogateKey %}
            		        identity
            			{% endif %}
            			{%- if not col.nullable %} NOT NULL
            				{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            			{% endif %}
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}

            	{% if config.insertZeroKey %}

            		{{ stage('Insert Zero Record') }}
            		INSERT INTO {{ this }}
            		(SELECT 
            		{% for col in sources[0].columns %}
            			{% set dtparams = col.dataType.partition('(')[-1].rpartition(')')[0].split(',') %}
            			{% if col.isSurrogateKey %}0
            				{% elif col.isSystemCurrentFlag %}'Y'
            				{% elif col.isSystemStartDate or col.isSystemEndDate or col.isSystemUpdateDate or col.isSystemCreateDate %}{{ get_source_transform(col) }}
            				{% elif col.isSystemVersion%}1
            				{% elif col.dataType[:3] | upper in ('NUM','INT','DEC','FLO') %}0
            				{% elif col.dataType[:4] | upper in ('DATE','TIME') %}CAST('0001-01-01' AS {{ col.dataType }})
            				{% elif col.dataType[:3] | upper in ('VAR','CHA','STR','BIN') %}
            					{% if dtparams[0] and dtparams[0] | int < 7 %}
            						SUBSTRING('UNKNOWN',1,{{ dtparams[0] }})
            					{% else %}
            						'UNKNOWN'
            					{% endif %}
            				{% elif col.nullable %}NULL
            				{% else %}''
            			{% endif %}
            			AS "{{ col.name }}"
            			{% if not loop.last %}, {% endif %}
            		{% endfor %}
            		)
            	{% endif %}

            {% elif node.materializationType == 'view' %}
            	{{ stage('Create Dimension View') }}

            	CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}"
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%},{% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            	AS
            	{% for source in sources %}

            		{% if loop.first %}SELECT {% endif %}

            		{% for col in source.columns %}
            			{% if col.isSurrogateKey or col.isSystemUpdateDate or col.isSystemCreateDate %}
                            NULL
            			{% else %}
                            {{ get_source_transform(col) }}
            			{% endif %}
            			AS "{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            		{{ source.join }}

            		{% if not loop.last %} UNION ALL {% endif %}
            	{% endfor %}

            {% endif %}
        run:
          templateString: |

            {% set is_type_2 = columns | selectattr("isChangeTracking") | list | length > 0 %}

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}

            	{% if config.preSQL %}			
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}
            	
                {% if is_type_2 %}

                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                        /* New Rows That Don't Exist */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_INITAL_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        LEFT JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                                {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "DIM"."{{ col.name }}" IS NULL
                        {% endfor %}
                        UNION ALL
                        /* New Row Needing To Be Inserted Due To Type-2 Column Changes */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                "DIM"."{{ col.name }}" + 1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_NEW_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Expired Due To Type-2 Column Changes
                        In this case, only two columns are merged (version and end date) */
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemEndDate %}
                                DATEADD(MILLISECONDS, -1, CAST(CURRENT_TIMESTAMP AS TIMESTAMP))
                            {% elif col.isSystemCurrentFlag %}
                                'N'
                            {% else %}
                                "DIM"."{{ col.name }}"
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'update_expired_version_rows' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        {# The if-block below avoids unnecessary updates when no type 2 column changes are present #}
                        {% if source.columns 
                            | rejectattr('isSurrogateKey')
                            | rejectattr('isBusinessKey')
                            | rejectattr('isChangeTracking')
                            | rejectattr('isSystemVersion')
                            | rejectattr('isSystemCurrentFlag')
                            | rejectattr('isSystemStartDate')
                            | rejectattr('isSystemEndDate')
                            | rejectattr('isSystemCreateDate')
                            | rejectattr('isSystemUpdateDate') 
                            | list | length == 0 
                        %}
                            {# Skip Section #}
                        {% else %}
                          UNION ALL
                          /* Rows Needing To Be Updated Due To Changes To Non-Type-2 columns
                          This case merges only when there are changes in non-type-2 column updates, but no changes in type-2 columns*/
                          SELECT
                          {%- for col in source.columns if not col.isSurrogateKey %}
                              {% if col.isSystemVersion or col.isSystemCreateDate or col.isSystemStartDate or col.isSystemEndDate %}
                                  "DIM"."{{ col.name }}"
                              {% elif col.isSystemCurrentFlag %}
                                  'Y'
                              {% else %}
                                  {{ get_source_transform(col) }}
                              {% endif %}
                              AS "{{ col.name }}",
                          {% endfor -%}
                              'UPDATE_NON_TYPE2_ROWS' AS "DML_OPERATION"
                          {{ source.join }}
                          INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                          {% for col in source.columns if col.isBusinessKey -%}
                              {% if not loop.first %}
                                  AND
                              {% endif %}
                              {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                          {% endfor %}
                          WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                          AND (
                          {% for col in source.columns if (col.isChangeTracking) -%}
                              {% if not loop.first %}
                                  AND
                              {% endif %}
                              {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                          {% endfor %} )
                          {% for col in source.columns if not (   col.isBusinessKey or
                                                                  col.isChangeTracking or
                                                                  col.isSurrogateKey or
                                                                  col.isSystemVersion or
                                                                  col.isSystemCurrentFlag or
                                                                  col.isSystemStartDate or
                                                                  col.isSystemEndDate or
                                                                  col.isSystemUpdateDate or
                                                                  col.isSystemCreateDate) -%}
                              {% if loop.first %}
                                  AND (
                              {% endif %}
                              {% if not loop.first %}
                                  OR
                              {% endif %}
                              NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**')
                              {% if loop.last %}
                                  )
                              {% endif %}
                          {% endfor %}
                        {% endif %}
                    ) AS "SRC"
                    ON
                    {% for col in source.columns if col.isBusinessKey -%}
                        {% if not loop.first %}
                            AND
                        {% endif %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                    {% endfor %}
                    AND "TGT"."{{ get_value_by_column_attribute("isSystemVersion") }}" = "SRC"."{{ get_value_by_column_attribute("isSystemVersion") }}"
                    WHEN MATCHED THEN UPDATE SET
                    {%- for col in source.columns if not (col.isBusinessKey or col.isSurrogateKey or col.isSystemCreateDate) %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    WHEN NOT MATCHED THEN INSERT (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )
                    VALUES (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )

                {% endfor %}



                {% else %}
                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string ) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                            SELECT
                            {% for col in source.columns if not col.isSurrogateKey %}
                                {% if col.isSystemVersion %}
                                	1
                                {% elif col.isSystemCurrentFlag %}
                                	'Y'
                                {% else %}
                                    {{ get_source_transform(col) }}
                                {% endif %}
                                AS "{{ col.name }}"
                                {%- if not loop.last %}, {% endif %}
                            {% endfor %}
                            {{ source.join }})
                            AS "SRC"
                        ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
                        {% endfor %}
                        WHEN MATCHED
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            NVL( CAST("SRC"."{{ col.name }}" as STRING), '**NULL**') <> NVL( CAST("TGT"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        THEN UPDATE SET
                        {%- for col in source.columns if not (  col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemCreateDate) %}
                                "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        WHEN NOT MATCHED THEN
                        INSERT (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                        VALUES (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                    {% endfor %}
                {% endif %}
            	
            	{% if config.postSQL %}			
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
    name: Dimension v2
    version: 1
  StepType-17:
    id: "17"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: UNLOAD
        short: 'EXPORT'
        tagColor: 'dodgerblue'
        isDisabled: false
        plural: Unloads

        config:
        - groupName: File Location
          items: 

          - displayName: Stage
            attributeName: fileLocation
            type: dropdownSelector
            default: "DOUGS3/export"
            options:
            - "DOUGS3/export"
            - "Name of Snowflake STAGE"
            - "Add STAGE to Template"
            isRequired: true

        - groupName: File Format 
          items:
          - displayName: File Type
            attributeName: fileType
            type: dropdownSelector
            default: CSV
            options:
            - "CSV"
            - "JSON"
            - "Parquet"
            isRequired: true

          - displayName: Compression
            attributeName: compression
            enableIf: "{{ config.fileType in ['CSV','JSON'] }}" 
            type: dropdownSelector
            options:
            - "AUTO"
            - "GZIP"
            - "BZ2"
            - "BROTLI"
            - "ZSTD"
            - "DEFLATE"
            - "RAW_DEFLATE"
            - "NONE"
            isRequired: false

          - displayName: Record delimiter
            attributeName: recDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\n"
            isRequired: false

          - displayName: Field delimiter
            attributeName: fieldDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: ","
            isRequired: false

          - displayName: Field optionally enclosed by
            attributeName: fieldEnclosed
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\\042"
            isRequired: false

          - displayName: Number of header lines to skip
            attributeName: skipHeader
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "1"
            isRequired: false

          - displayName: Skip blank lines
            attributeName: skipBlankLines
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

          - displayName: Trim space
            attributeName: trimSpace
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

        - groupName: Additional Options
          items:
          - displayName: Overwrite existing files
            attributeName: overwrite
            type: toggleButton
            default: true
            isRequired: false
          - displayName: Single file
            attributeName: singleFile
            type: toggleButton
            default: true
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            isRequired: false
      templates:
        create:
          templateString: |-
            {{ stage('Nothing to create') }}
            SELECT 1
        run:
          templateString: |-
            {% for source in sources %}
                {% for dep in source.dependencies if dep.node %}
                    {{ stage('Unloading ' + dep.node.name | string ) }}
                    COPY INTO @{{parameters.stage_location}}.{{config.fileLocation }}/{{node.name }}{% if config.singleFile %}.{{ config.fileType | lower }}{% endif %}
                    FROM {{ ref_no_link(dep.node.location.name, dep.node.name) | upper }}
                    overwrite = {{ config.overwrite }}
                    single = {{ config.singleFile }}
                    file_format = (type = {{ config.fileType }}
                    {% if config.fileType == "CSV" %}
                        {% if config.recDelim != null %}record_delimiter = '{{ config.recDelim }}'{% endif %}
                        {% if config.fieldDelim != null %}field_delimiter = '{{ config.fieldDelim }}'{% endif %}
                        {% if config.fieldEnclosed != null %}field_optionally_enclosed_by = '{{ config.fieldEnclosed }}'{% endif %}
                        {% if config.skipHeader != null %}skip_header = {{ config.skipHeader }}{% endif %}
                        {% if config.skipBlankLines %}skip_blank_lines = {{ config.skipBlankLines }}{% endif %}
                        {% if config.trimSpace %}trim_space = {{ config.trimSpace }}{% endif %}
                    {% endif %}
                    )
                {% endfor %}
            {% endfor %}

            {{ stage('Completed') }}
            CREATE OR REPLACE VIEW {{this}}
            AS
            SELECT 1 Finished
    name: Unload
    version: 1
  StepType-18:
    id: "18"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: MULTI-ACTIVE SATELLITE V0'
        short: 'SATMV0'
        plural: 'DATAVAULT BY SCALEFREE: MULTI-ACTIVE SATELLITES V0'
        tagColor: '#dfdf1f'

        config:
        - groupName: Data Vault
          items:
          - displayName: Hashkey Column
            type: columnSelector
            attributeName: is_hk
            isRequired: true
          
          - displayName: Multi-Active Key Column
            type: columnSelector
            attributeName: is_ma_key
            isRequired: true

          - displayName: Hashdiff Column
            type: columnSelector
            attributeName: is_hd
            isRequired: true

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false
      templates:
        create:
          templateString: |
            {{ stage('Create Satellite Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
              {% for col in columns %}
                "{{ col.name }}" {{ col.dataType }}
                {%- if not col.nullable %} NOT NULL
                  {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                {% endif %}
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
              {{ stage('Pre-SQL') }}
              {{ config.preSQL }}
            {% endif %}

            {{ stage('Insert New Rows') }}

            INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH latest_entries_in_sat AS (
              /* get current rows from satellite */

              {# /* USE THIS again when ColumnDropdownSelector is used
              {%- set hashkey_column = config.is_hk.name -%}
              {%- set hashdiff_column = config.is_hd.name -%} */ #}
              
              {%- set hashkey_column = get_value_by_column_attribute("is_hk") -%}
              {%- set hashdiff_column = get_value_by_column_attribute("is_hd") -%}

              SELECT 
                "{{ hashkey_column }}",
                "{{ hashdiff_column }}"

              FROM {{ ref_no_link(node.location.name, node.name) }} 

              QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" DESC) = 1

            ),

            deduplicated_numbered_source AS (
                
                {% for source in sources %}

                    SELECT
                {% for col in source.columns %}
                  {{ get_source_transform(col) }} AS {{ col.name }},
                {% endfor %}
                    ROW_NUMBER() OVER(PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}") as rn
                    
                    {{ source.join }}

                {% if not config.disable_hwm -%}
                WHERE "{{ datavault4coalesce.config.ldts_alias }}" > (
                  SELECT 
                    COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
                  FROM {{ ref_no_link(node.location.name, node.name) }}
                  WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                  )
                  OR "{{ hashkey_column }}" = {{ datavault4coalesce__unknown_key() }}
                  OR "{{ hashkey_column }}" = {{ datavault4coalesce__error_key() }}
                {% endif %}  
                    QUALIFY
                    CASE
                        WHEN "{{ hashdiff_column }}" = LAG("{{ hashdiff_column }}") OVER(PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) THEN FALSE
                        ELSE TRUE
                    END

                {% endfor %}

            )

              {% for source in sources %}
                SELECT DISTINCT
                {% for col in source.columns %}
                  {{ col.name }}
                  {%- if not loop.last -%}, {% endif %}
                {% endfor %}

                FROM deduplicated_numbered_source
              WHERE NOT EXISTS (
                SELECT 1 FROM latest_entries_in_sat
                WHERE 
                  deduplicated_numbered_source.{{ hashdiff_column }} = latest_entries_in_sat."{{ hashdiff_column }}"
                AND deduplicated_numbered_source.{{ hashkey_column }} = latest_entries_in_sat."{{ hashkey_column }}"
                    AND deduplicated_numbered_source.rn = 1
              )

              {% endfor %}

            {% if config.postSQL %}
              {{ stage('Post-SQL') }}
              {{ config.postSQL }}
            {% endif %}
    name: "Datavault by Scalefree: Multi-active Satellite V0"
    version: 1
  StepType-180:
    id: "180"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Snowpark Stage
        short: PY
        plural: Snowpark stages
        tagColor: 'blue'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            default: table
            options:
            - table
            isRequired: true
            enableIf: "false"

          - displayName: Write Mode
            attributeName: writeMode
            type: dropdownSelector
            default: overwrite
            options: 
            - overwrite
            - append
            enableIf: "true"

          - displayName: Python Libraries
            attributeName: pyLib
            type: textBox 
            syntax: sql
            isRequired: false   
            default: "import snowflake.snowpark as snowpark"

          - displayName: Dataframe Commands (df_raw -> df_final)
            attributeName: dfcmd
            type: textBox 
            syntax: sql
            isRequired: true    
            default: " \n
        df_filtered = df_raw.filter(\"C_ACCTBAL > 5000\")\n
        df_distinct = df_filtered.distinct()\n
        df_final = df_distinct.na.drop(subset=\"C_PHONE\")\n
        "

          - displayName: "https://docs.snowflake.com/en/developer-guide/snowpark/reference/python/latest/dataframe"
            attributeName: Info
            type: label
      templates:
        create:
          templateString: |-
            {{ stage('Create Stage Table') }}

            	CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{%- for col in columns %}
            			"{{ col.name }}" {{ col.dataType }}
            			{%- if not col.nullable %} NOT NULL
            				{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            			{% endif %}
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}



            {{ stage('Create Python Procedure ') }}
            {% set source = sources[0] %}

            CREATE OR REPLACE PROCEDURE {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}()
              returns string not null
              language python
              runtime_version = '3.8'
              packages = ('snowflake-snowpark-python', 'pandas') 
              handler = 'stage_py'
            as
            $$
            {{ config.pyLib }}

            def stage_py(snowpark_session):
              df_raw = snowpark_session.sql('''SELECT 
              {%- for col in source.columns %}
                {{ get_source_transform(col) }} AS "{{ col.name }}"
            	{%- if not loop.last -%}, {% endif %}
              {%- endfor %} {{ source.join }} '''.rstrip())

            {%- set dfca = config.dfcmd.split('\n') %}
            {%- for dfc in dfca %}
              {{ dfc.lstrip() }}
            {%- endfor %}
              df_final.write.mode("{{config.writeMode}}").save_as_table('{{this}}')
              return str(df_raw.count()) + " rows input - " +  str(df_final.count()) + " rows output"
            $$
        run:
          templateString: |-
            {{ stage('Run Stored Procedure') }}
            CALL {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}()
    name: Snowpark Stage Table
    version: 1
  StepType-187:
    id: "187"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: API Call
        short: API
        plural: Excel Files
        tagColor: 'orange'
        config:
        - groupName: Documentation
          items:

          - displayName: Documentation
            attributeName: doc
            synatx: sql
            type: textBox
            default: "
        -- Create a Network Rule on Snowflake
        CREATE OR REPLACE  NETWORK RULE COALESCE_API_RULE
        MODE = EGRESS
        TYPE = HOST_PORT
        VALUE_LIST = ('APP.COALESCESOFTWARE.IO');

        -- Create Integration to access Coalesce API
        CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION COALESCE_API_INTEGRATION
        ALLOWED_NETWORK_RULES = (COALESCE_API_RULE)
        ENABLED=TRUE;"

        - groupName: Options
          items:
          - displayName: Snowflake EXTERNAL ACCESS INTEGRATION Name
            attributeName: extIntegration
            type: textBox
            default: "COALESCE_API_INTEGRATION"
            isRequired: true

          - displayName: Method
            attributeName: method
            type: dropdownSelector
            default: "get"
            options:
            - "get"
            - "post"
            - "put"
            isRequired: true

          - displayName: URI
            attributeName: uri
            type: textBox
            default: 'https://app.coalescesoftware.io/api/v1/runs'
            isRequired: true

          - displayName: Headers
            attributeName: headers
            type: textBox
            default: '{
                "accept": "application/json",
                "authorization": "Bearer "
            }'
            isRequired: false

          - displayName: Payload
            attributeName: payload
            type: textBox
            default: ''
            isRequired: false

        systemColumns:
        - displayName: 'URI'
          attributeName: uri
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: 'RESPONSE'
          attributeName: value
          transform: ''
          dataType: VARIANT
          placement: end
      templates:
        create:
          templateString: |-
            {{ stage('Create Table') }}
            CREATE OR REPLACE TABLE {{ this }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}" {{ col.dataType }}
            			{% if col.isSurrogateKey %}
            		        identity
            			{% endif %}
            			{%- if not col.nullable %} NOT NULL
            				{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            			{% endif %}
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}



            {{ stage('Create Python Procedure ') }}
            CREATE OR REPLACE PROCEDURE {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}()
            RETURNS STRING
            language python
            runtime_version=3.8
            handler = 'call_api'
            external_access_integrations=({{config.extIntegration}})
            packages = ('snowflake-snowpark-python','requests','pandas')
            as 
            $$
            import _snowflake
            import requests
            import json
            from snowflake.snowpark.functions import sql_expr
            from snowflake.snowpark.functions import lit 

            def call_api(snowpark_session):
            	h = json.loads('''{{config.headers}}''')
            	{% if config.payload != None and config.payload != "" %}p = json.loads('''{{config.payload}}'''){% endif%}
            	uri = '''{{config.uri}}'''
            	response = requests.{{ config.method }}(uri, headers=h {%- if config.payload != None and config.payload != ""%}, payload=p {%- endif%})
            	data = response.text
            	df = snowpark_session.create_dataframe([data]).to_df("RESPONSE")
            	df = df.withColumn("RESPONSE",sql_expr("parse_json(RESPONSE)"))
            	df = df.with_column('URI', lit(uri))
            	df.write.mode("overwrite").save_as_table('{{this}}')
            	return str(data)
            $$;
        run:
          templateString: |-
            {{ stage('Run Stored Procedure') }}
            CALL {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}()
    name: API Call
    version: 1
  StepType-195:
    id: "195"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: JDBC Load
        short: JDBC
        plural: JDBC Loads
        tagColor: 'orange'
        config:

        - groupName: Options
          items:
          - displayName: JDBC Driver
            attributeName: jdbc_driver
            type: dropdownSelector
            default: "com.microsoft.sqlserver.jdbc.SQLServerDriver"
            options:
            - "com.microsoft.sqlserver.jdbc.SQLServerDriver"
            - "oracle.jdbc.driver.OracleDriver"
            - "com.mysql.jdbc.Driver"
            isRequired: true

          - displayName: JDBC URL
            attributeName: jdbc_url
            type: textBox
            default: "jdbc:sqlserver://coalesce-source.database.windows.net:1433;database=coalesce_source"
            isRequired: true

          - displayName: SQL
            attributeName: sql
            type: textBox
            default: "SELECT * FROM saleslt.customer"
            isRequired: true

          - displayName: Truncate Before
            attributeName: truncateBefore
            type: toggleButton
            default: true
            
        systemColumns:
        - displayName: 'DATA'
          attributeName: data
          transform: ''
          dataType: VARIANT
          placement: beginning

        - displayName: SYSTEM_LOAD_TIMESTAMP
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate
      templates:
        create:
          templateString: |+
            {{ stage('Create Table') }}
            CREATE OR REPLACE TABLE {{ this }}
            (
            	{% for col in columns %}
            		"{{ col.name }}" {{ col.dataType }}
            		{%- if not col.nullable %} NOT NULL
            			{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            		{% endif %}
            		{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            		{%- if not loop.last -%}, {% endif %}
            	{% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}

        run:
          templateString: |-
            {% if config.truncateBefore %}
            	
                {{ stage('Truncate Table') }}
                TRUNCATE IF EXISTS {{ this }}

            {% endif %}


            {{ stage('Run Insert Function') }}
            INSERT INTO {{this}} (DATA, SYSTEM_LOAD_TIMESTAMP)
            SELECT DATA, CURRENT_TIMESTAMP FROM TABLE (DOUG_DB.PUBLIC.READ_JDBC(OBJECT_CONSTRUCT(
                'driver', '{{config.jdbc_driver}}',
                'url', '{{config.jdbc_url}}'),
                '{{config.sql}}'
            ))
    name: JDBC Load
    version: 1
  StepType-198:
    id: "198"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: ML FORECAST 2
        short: ML_FCSTS
        tagColor: 'blue'
        plural: ML Forecasts

        config:

        - groupName: Forecast Model Input
          items:

            - type: toggleButton
              displayName: 'Multi-Series Forecast'
              attributeName: 'multiseries'
              isRequired: false
              default: 'true'

            - type: columnDropdownSelector
              displayName: 'Series Column'
              attributeName: 'seriescol'
              isRequired: false
              enableIf: "{{ config.multiseries }}"

            - type: columnDropdownSelector
              displayName: 'Timestamp Column'
              attributeName: 'tscol'
              isRequired: true

            - type: columnDropdownSelector
              displayName: 'Target Column'
              attributeName: 'tgtcol'
              isRequired: true

            - type: toggleButton
              displayName: 'Exogenous Variables'
              attributeName: 'exvar'
              isRequired: false
              default: 'true'
          
            - displayName: Days To Forecast
              attributeName: fcdays
              type: textBox
              enableIf: '{%- if not config.exvar %}true{%- else %}false{%- endif %}' 
              isRequired: false
              default: '30'

        systemColumns:
        - displayName: "FORECAST"
          attributeName: forecast
          transform: ""
          dataType: FLOAT
          placement: end
          description: 'Generated by ML Forecast Model'
        - displayName: "LOWER_BOUND"
          attributeName: lower_bound
          transform: ""
          dataType: FLOAT
          placement: end
          description: 'Generated by ML Forecast Model'
        - displayName: "UPPER_BOUND"
          attributeName: upper_bound
          transform: ""
          dataType: FLOAT
          placement: end
          description: 'Generated by ML Forecast Model'
      templates:
        create:
          templateString: |+
            {% set source = sources[0] %}
            {% set src_node = source.dependencies[0].node %}
            {% set forecast_name = 'FORECAST_' ~ src_node.name %}

            {{ stage('Create Forecast Table') }}


            CREATE OR REPLACE TABLE {{ this }}
            (
                {% for col in source.columns  %}
                    "{{ col.name }}" 
                    {%- if col.name == config.tscol.name %} TIMESTAMP 
                    {%- elif col.name == config.tgtcol.name %} FLOAT 
                    {%- else %} {{ col.dataType }}
                    {%- endif %}
                    {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{%- endif %}
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}


        run:
          templateString: |+
            {% set source = sources[0] %}
            {% set src_node = source.dependencies[0].node %}
            {% set forecast_name = 'FORECAST_' ~ src_node.name %}

            {{ stage('Truncate Forecast table') }}
            TRUNCATE IF EXISTS {{ this }}

            {{ stage('Populate Forecast Table with Historical Data') }}

            INSERT INTO {{ this }}
            (
                {%- for col in source.columns  %} 
                    "{{ col.name }}" {%- if not loop.last -%}, {% endif %}
                {%- endfor %}
            )
            SELECT 
                {% for col in source.columns  %} 
                    {{ get_source_transform(col) }} AS "{{ col.name }}"
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            {{ source.join }}

            {{ stage('Create Forecast Model Instance') }}

            CREATE OR REPLACE SNOWFLAKE.ML.FORECAST
             {{ ref_no_link(node.location.name, forecast_name) }}(
                INPUT_DATA => SYSTEM$QUERY_REFERENCE('
                    SELECT
                    {%- for col in columns if not (col.forecast or col.upper_bound or col.lower_bound) %}
                        "{{col.name}}"{%- if not loop.last %}, {%- endif %}
                    {%- endfor %}            
                    FROM {{ this }}
                    WHERE  "{{ config.tgtcol.name }}" IS NOT NULL
                '),
                {% if config.multiseries %}SERIES_COLNAME => '{{ config.seriescol.name }}', {% endif %}
                TIMESTAMP_COLNAME => '{{ config.tscol.name }}',
                TARGET_COLNAME => '{{ config.tgtcol.name }}'
            )


            {{ stage('Insert Forecast data') }}
            BEGIN

            {% if config.exvar %}
                CALL {{ ref_no_link(node.location.name, forecast_name) }}!FORECAST(
                    INPUT_DATA => SYSTEM$QUERY_REFERENCE('
                    SELECT 
                    {%- for col in columns if not (col.forecast or col.upper_bound or col.lower_bound) %}
                        "{{col.name}}"{%- if not loop.last %}, {%- endif %}
                    {%- endfor %}            
                    FROM {{ this }}
                    WHERE  "{{ config.tgtcol.name }}" IS NULL
                '),
                {%if config.multiseries %}SERIES_COLNAME => '{{ config.seriescol.name }}', {% endif %}
                TIMESTAMP_COLNAME => '{{ config.tscol.name }}' );

                UPDATE {{ this }} SRC
                SET 
                    {%- for col in columns if  col.forecast or col.lower_bound or col.upper_bound %}
                        "{{ col.name }}" = RES."{{ col.name }}" {%- if not loop.last %}, {%- endif %}
                    {%- endfor %}
                FROM TABLE(RESULT_SCAN(-1)) RES
                WHERE 
                    RES."TS" = SRC."{{ config.tscol.name }}"
                    {%- if config.multiseries  %}
                    AND RES."SERIES" = SRC."{{ config.seriescol.name }}"            
                    {%- endif %};

            {% else %}

                CALL {{ ref_no_link(node.location.name, forecast_name) }}!FORECAST({{ config.fcdays }});

                INSERT INTO {{ this }}
                (
                    {%- for col in source.columns  %} 
                        "{{ col.name }}" {%- if not loop.last -%}, {% endif %}
                    {%- endfor %}
                )
                SELECT 
                    {% for col in source.columns %}
                        {%- if config.multiseries and col.id == config.seriescol.id %}"SERIES"
            	        {%- elif col.id == config.tscol.id %}"TS"
            	        {%- elif col.id == config.tgtcol.id %}NULL
            	        {%- elif col.forecast or col.lower_bound or col.upper_bound %}"{{ col.name }}"
            	        {%- else %}{{ get_source_transform(col) }} AS "{{ col.name }}"
            	        {%- endif %}{%- if not loop.last %}, {%- endif %}
                    {% endfor %}
                FROM TABLE(RESULT_SCAN(-1)) RES;
            {% endif %}


            END


    name: ML Forecast
    version: 1
  StepType-20:
    id: "20"
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |-
        capitalized: PII View
        short: VPII
        tagColor: 'red'
        isDisabled: true
        plural: Views

        config:
          - groupName: Documentation
            items:
            - displayName: Description
              attributename: description
              type: textBox
              isRequired: false
              default: "A PII View adds a masking policy to specific attributes marked using the PII Flag column.  Allowed values (PII or blank)."

          - groupName: Options
            items: 

            - displayName: Masking policy name
              attributeName: maskingPolicy
              type: textBox
              isRequired: true

          - groupName: Hidden config
            enableIf: "false"
            items:
            - displayName: Type
              type: materializationSelector
              default: view
              options:
              - view
              isRequired: true

        mappingColumns:                                  
        - type: textBox                                  
          headerName: 'PII Flag'                        
          attributeName: piiFlag
      templates:
        create:
          templateString: |+
            {% set source = sources[0] %}
            {{ stage('Create View') }}
            CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                    "{{ col.name }}"{%- if col.piiFlag | upper == "PII"%} MASKING POLICY "{{config.maskingPolicy}}" {% endif %}
                    {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
            AS

            SELECT {% if config.selectDistinct %} DISTINCT {% endif %}
            {% for col in source.columns %}
                {{ get_source_transform(col) }} AS "{{ col.name }}"
                {%- if not loop.last -%}, {% endif %}
            {% endfor %}

            {{ source.join }}


        run:
          templateString: ""
    name: PII View
    version: 1
  StepType-207:
    id: "207"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Copy of Snowpipe
        short: 'LOAD'
        tagColor: '#C39BD3'
        isDisabled: false
        plural: Snowpipe

        config:
        - groupName: File Location
          items: 

          - displayName: Stage
            attributeName: fileLocation
            type: dropdownSelector
            default: "DOUGS3/csv"
            options:
            - "DOUGS3/csv"
            - "Create external stages on Snowflake"
            - "Place them in the same storage location"
            - "List the storage locations in this dropdown"
            isRequired: true

          - displayName: File Pattern
            attributeName: filePattern
            type: textBox
            default: ".*[.]csv"
            isRequired: false

          - displayName: File Format
            attributeName: fileFormat
            type: dropdownSelector
            default: my_csv_format
            options:
            - my_csv_format
            isRequired: true

          - displayName: Auto Ingest
            attributeName: autoIngest
            type: toggleButton
            default: true
            isRequired: false

          - displayName: Integration
            attributeName: inteGration
            type: dropdownSelector
            default: None
            options:
            - None
            - INTEGRATION
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            isRequired: true

        systemColumns:
          
        - displayName: COL1
          attributeName: col1
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL2
          attributeName: col2
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL3
          attributeName: col3
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL4
          attributeName: col4
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL5
          attributeName: col5
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL6
          attributeName: col6
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL7
          attributeName: col7
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL8
          attributeName: col8
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL9
          attributeName: col9
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL10
          attributeName: col10
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL11
          attributeName: col11
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL12
          attributeName: col12
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL13
          attributeName: col13
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL14
          attributeName: col14
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL15
          attributeName: col15
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL16
          attributeName: col16
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL17
          attributeName: col17
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL18
          attributeName: col18
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL19
          attributeName: col19
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: COL20
          attributeName: col20
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: 'FILE_NAME'
          attributeName: fileName
          transform: ''
          dataType: STRING
          placement: beginning

        - displayName: 'FILE_ROW_NUMBER'
          attributeName: fileRN
          transform: ''
          dataType: STRING
          placement: beginning
      templates:
        create:
          templateString: |+
            {% set source = sources[0] %}

            {{ stage('Create Landing table')}}
            CREATE OR REPLACE TABLE {{this}} 
            (
                {% for col in source.columns  %}
                  "{{ col.name }}" {{ col.dataType }} 
                  {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )

            {{ stage('Create Snowpipe') }}
            CREATE OR REPLACE PIPE  {{ this | replace (node.name, "PIPE_"+node.name) }}
              auto_ingest = true
              {% if config.inteGration != 'None'%}INTEGRATION = '{{config.inteGration}}'{% endif %}
            AS
              COPY INTO {{ this }} (
                {%- for col in columns  %}
                    "{{ col.name }}" 
                  {%- if not loop.last -%},{% endif %}
                {%- endfor %}
              )
              FROM ( 
                SELECT 
                {%- for col in source.columns  %}
                  {%- if col.fileName %} METADATA$FILENAME 
                  {%- elif col.fileRN %} METADATA$FILE_ROW_NUMBER
                  {%- else %}
                    t.${{loop.index}}::{{ col.dataType }}
                  {%- endif %}
                  {%- if not loop.last -%}, {% endif %}
                {%- endfor %}
                FROM  @{{parameters.stage_location}}.{{ config.fileLocation }}
                (FILE_FORMAT => '{{parameters.stage_location}}.{{ config.fileFormat }}') t 
              )
              {% if config.filePattern | length > 0 %}PATTERN = '{{ config.filePattern}}' {% endif %}

        run:
          templateString: |-
            {% set source = sources[0] %}
            {{ stage('Run Copy') }}

            COPY INTO {{ this }} (
                {%- for col in columns  %}
                    "{{ col.name }}" 
                  {%- if not loop.last -%},{% endif %}
                {%- endfor %}
              )
              FROM ( 
                  SELECT 
                  {%- for col in source.columns  %}
                    {%- if col.fileName %} METADATA$FILENAME 
                    {%- elif col.fileRN %} METADATA$FILE_ROW_NUMBER
                    {%- else %}
                      t.${{loop.index}}::{{ col.dataType }}
                    {%- endif %}
                    {%- if not loop.last -%}, {% endif %}
                  {%- endfor %}
                  FROM  @{{parameters.stage_location}}.{{ config.fileLocation }}
                  (FILE_FORMAT => '{{parameters.stage_location}}.{{ config.fileFormat }}') t 
                )
              PATTERN = '{{ config.filePattern}}'
    name: Snowpipe V2
    version: 1
  StepType-21:
    id: "21"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: MULTI-ACTIVE SATELLITE V1'
        short: 'SATMV1'
        plural: 'DATAVAULT BY SCALEFREE: MULTI-ACTIVE SATELLITES V1'
        tagColor: '#e39103'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            enableIf: 'true'
            default: view
            options:
            - view
        - groupName: Data Vault
          items:
          - displayName: Hashkey Column
            type: columnSelector
            attributeName: is_hk
            isRequired: true

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "LEDTS"
          transform: |-
            COALESCE(LEAD("{{ datavault4coalesce.config.ldts_alias }}" - INTERVAL '1 MICROSECOND') 
            OVER (PARTITION BY "{{ get_value_by_column_attribute("is_hk") }}", "{{ get_source_ma_keys(delimiter=',') }}"  
            ORDER BY "{{ datavault4coalesce.config.ldts_alias }}"), {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }})
          dataType: TIMESTAMP
          placement: end
          attributeName: is_system_ledts
        - displayName: "IS_CURRENT"
          transform: |-
            CASE 
              WHEN 
                LEAD("{{ datavault4coalesce.config.ldts_alias }}" - INTERVAL '1 MICROSECOND') 
                OVER (PARTITION BY "{{ get_value_by_column_attribute("is_hk") }}", "{{ get_source_ma_keys(delimiter=',') }}"
                ORDER BY "{{ datavault4coalesce.config.ldts_alias }}") IS NULL 
              THEN TRUE 
              ELSE FALSE 
            END
          dataType: BOOLEAN
          placement: end
          attributeName: is_system_current_col
      templates:
        create:
          templateString: |-
            {{ stage('Create Satellite View') }}

            CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                   "{{ col.name }}"
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
              {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}

            AS
            {% for source in sources %}
                SELECT
                {% for col in source.columns %}
                    {{ get_source_transform(col) }} AS "{{ col.name }}"
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
                {{ source.join }}
            {% endfor %}
        run:
          templateString: ""
    name: "Datavault by Scalefree: Multi-active Satellite v1"
    version: 1
  StepType-23:
    id: "23"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: NON-HISTORIZED LINK'
        short: 'NHLINK'
        tagColor: '#F88379'
        plural: 'DATAVAULT BY SCALEFREE: NON-HISTORIZED LINKS'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            enableIf: 'false'
            default: table
            options:
            - table

          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false
            
          - type: multisourceToggle
          
        - groupName: Data Vault
          items:
          - displayName: Link Hashkey Column
            type: columnSelector
            attributeName: is_Link_hk
            isRequired: true 
          - displayName: Source is Single Batch?
            type: toggleButton
            isRequired: true
            attributeName: source_is_single_batch
            default: false
          - displayName: Disable High-Water-Mark?
            type: toggleButton
            isRequired: false
            enableIf: 'false'
            attributeName: disable_hwm   
            default: true
      templates:
        create:
          templateString: |-
            {{ stage('Create Link Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                    "{{ col.name }}" {{ col.dataType }}
                    {%- if not col.nullable %} NOT NULL
                        {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                    {% endif %}
                    {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
                {{ stage('Pre-SQL') }}
                {{ config.preSQL }}

            {% endif %}

            {% for source in sources %}
                        
                {{ stage('INSERT INTO Non-Historized Link - ' ~ source.name) }}

                {#--USE AGAIN WHEN COLUMNDROPDOWNSELECTOR IS USED  set link_hashkey = config.is_Link_hk.name -#}
                {%- set link_hashkey = get_value_by_column_attribute("is_Link_hk") -%}

                INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH incoming AS 
                (
                    SELECT DISTINCT
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}
                ),

            new_records AS (
                SELECT
                    "SRC".*
                FROM incoming "SRC"
                WHERE NOT EXISTS (
                    SELECT
                        1
                    FROM {{ ref_no_link(node.location.name, node.name) }} "TGT"
                    WHERE "SRC"."{{ link_hashkey }}" = "TGT"."{{ link_hashkey }}"
                )

                {% if not config.disable_hwm -%}
                AND "SRC"."{{ datavault4coalesce.config.ldts_alias }}" > (
                    SELECT 
                        COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
                    FROM {{ ref_no_link(node.location.name, node.name) }}
                    WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                    )
                {%- endif %}

                {% if not config.source_is_single_batch %}
                QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ link_hashkey }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) = 1
                {%- endif %}
            )

            SELECT * FROM new_records

            {% endfor %}

            {% if config.postSQL %}
                {{ stage('Post-SQL') }}
                {{ config.postSQL }}    
            {% endif %}
    name: "Datavault by Scalefree: Non-Historized Link"
    version: 1
  StepType-24:
    id: "24"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: NON-HISTORIZED SATELLITE'
        short: 'NHSAT'
        plural: 'DATAVAULT BY SCALEFREE: NON-HISTORIZED SATELLITES'
        tagColor: '#FFFF8F'

        config:
        - groupName: Data Vault
          items:
          - displayName: Hashkey Column
            type: columnSelector
            attributeName: is_hk
            isRequired: true

          - displayName: Source is Single Batch?
            type: toggleButton
            isRequired: true
            attributeName: source_is_single_batch
            default: false
            
          - displayName: Disable High-Water-Mark?
            type: toggleButton
            isRequired: true
            attributeName: disable_hwm   
            default: false

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false
      templates:
        create:
          templateString: |
            {{ stage('Create Satellite Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
              {% for col in columns %}
                "{{ col.name }}" {{ col.dataType }}
                {%- if not col.nullable %} NOT NULL
                  {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                {% endif %}
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
                {{ stage('Pre-SQL') }}
                {{ config.preSQL }}

            {% endif %}

            {% for source in sources %}
                        
                {{ stage('INSERT INTO Non-Historized Satellite - ' ~ source.name) }}

                {#%-- USE again when ColumnDropdownSelector is used! set link_hashkey = config.is_hk.name -%#}
                {%- set link_hashkey = get_value_by_column_attribute("is_hk") -%}

                INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH incoming AS 
                (
                    SELECT DISTINCT
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}
                    
                    {% if not config.disable_hwm -%}
                    WHERE "{{ datavault4coalesce.config.ldts_alias }}" > (
                        SELECT 
                            COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }}) 
                        FROM {{ ref_no_link(node.location.name, node.name) }}
                  WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                        )
                    {%- endif %}

                    {% if not config.source_is_single_batch %}
                    QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ link_hashkey }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) = 1
                    {%- endif %}

                ),

            new_records AS (
                SELECT
                    "SRC".*
                FROM incoming "SRC"
                WHERE NOT EXISTS (
                    SELECT
                        1
                    FROM {{ ref_no_link(node.location.name, node.name) }} "TGT"
                    WHERE "SRC"."{{ link_hashkey }}" = "TGT"."{{ link_hashkey }}"
                )
            )

            SELECT * FROM new_records

            {% endfor %}

            {% if config.postSQL %}
                {{ stage('Post-SQL') }}
                {{ config.postSQL }}    
            {% endif %}
    name: "Datavault by Scalefree: Non-Historized Satellite"
    version: 1
  StepType-27:
    id: "27"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: RECORD TRACKING SATELLITE'
        short: 'RTS'
        plural: 'DATAVAULT BY SCALEFREE: RECORD TRACKING SATELLITES'
        tagColor: 'gold'

        joinTemplate: |-
          FROM {{ ref_raw(sources[0].dependencies[0].node.location.name,sources[0].dependencies[0].node.name) }} "{{ sources[0].dependencies[0].node.name }}"
          WHERE "{{ sources[0].dependencies[0].node.name }}"."{{ datavault4coalesce.config.ldts_alias }}" > 
          (SELECT COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),{{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
          FROM {{ this }}
          WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }})
        config:
        - groupName: Data Vault
          items:
          - displayName: Hashkey Column
            type: columnDropdownSelector
            attributeName: is_hk
            isRequired: false

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "STG"
          transform: "'{{ sources[0].dependencies[0].node.location.name }}.{{ sources[0].dependencies[0].node.name }}'"
          dataType: STRING
          placement: end
          attributeName: is_stg    
          description: "The Stage (STG) references the exact source of this data, specific for record tracking."
      templates:
        create:
          templateString: |
            {{ stage('Create Record Tracking Satellite Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
              {% for col in columns %}
                "{{ col.name }}" {{ col.dataType }}
                {%- if not col.nullable %} NOT NULL
                  {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                {% endif %}
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
              {{ stage('Pre-SQL') }}
              {{ config.preSQL }}
            {% endif %}


            {%- set hashkey_column = config.is_hk.name -%}

            {{ stage('Insert New Rows') }}
            INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            WITH distinct_concated_target AS (
                    SELECT
                    CONCAT_WS('||',
                    "{{ hashkey_column }}",
                    "{{ datavault4coalesce.config.ldts_alias }}",
                    "{{ datavault4coalesce.config.rsrc_alias }}"
                    ) AS "concat"
                    FROM {{ this }}
                ),
              {% for source in sources %}
                src_new_{{ loop.index }} AS (
                        SELECT DISTINCT
                            "{{ hashkey_column }}",
                            "{{ datavault4coalesce.config.ldts_alias }}",
                            "{{ datavault4coalesce.config.rsrc_alias }}",
                        {%- for col in source.columns if col.is_stg -%}
                            {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- endfor %}
                        {{ source.join }}
                    ),
                {% endfor %}
                records_to_insert AS (
                {% for source in sources %}
                
                SELECT
                        "{{ hashkey_column }}",
                        "{{ datavault4coalesce.config.ldts_alias }}",
                        "{{ datavault4coalesce.config.rsrc_alias }}",
                        "{{ datavault4coalesce.config.stg_alias }}" 
                    FROM src_new_{{ loop.index }}
                    WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                    AND "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }}
                        AND CONCAT_WS('||',
                            "{{ hashkey_column }}",
                            "{{ datavault4coalesce.config.ldts_alias }}",
                            "{{ datavault4coalesce.config.rsrc_alias }}"
                            ) NOT IN (SELECT "concat" FROM distinct_concated_target)
                    {% if not loop.last %}UNION ALL{% endif %}
                {% endfor %}
                    
                )
            SELECT
                {%- for col in columns %}
                    "{{ col.name }}"
                    {%- if not loop.last %},{% endif %}
                {%- endfor -%}
            FROM records_to_insert

            {% if config.postSQL %}
              {{ stage('Post-SQL') }}
              {{ config.postSQL }}
            {% endif %}
    name: "Datavault by Scalefree: Record-Tracking Satellite"
    version: 1
  StepType-4:
    id: "4"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: Stage Date
        short: DATE
        plural: Dates
        tagColor: 'black'
        config:
        - groupName: Date Options
          items:
          - displayName: Starting Date
            attributeName: startingDate
            type: textBox
            syntax: sql
            default: 'DATEADD(DAY, -730, CURRENT_DATE)'
          - displayName: Number of Days to Generate
            attributeName: daysToGenerate
            type: textBox
            default: '2000'
          - displayName: Generated Date Column Name
            attributeName: dateColumnName
            type: textBox
            default: '"DATE_COL"'
        - groupName: Additional Options
          items:
          - type: materializationSelector
            default: table
            options:
            - table
            isRequired: true
          - displayName: Truncate Before
            attributeName: truncateBefore
            type: toggleButton
            default: true
            isRequired: true
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false
          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false
        systemColumns:
        - displayName: DATE_KEY
          transform: '{{ config.dateColumnName }}'
          dataType: 'DATE'
          placement: beginning
          attributeName: isDate
        - displayName: 'YEAR'
          transform: 'YEAR({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isYear
        - displayName: 'MONTH'
          transform: 'MONTH({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isMonth
        - displayName: 'MONTH_NAME'
          transform: 'MONTHNAME({{ config.dateColumnName }})'
          dataType: CHAR(3)
          placement: beginning
          attributeName: isMonthName
        - displayName: 'DAY_OF_MONTH'
          transform: 'DAY({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isDayOfMonth
        - displayName: 'DAY_OF_WEEK'
          transform: 'DAYOFWEEK({{ config.dateColumnName }})'
          dataType: VARCHAR(9)
          placement: beginning
          attributeName: isDayOfWeek
        - displayName: 'WEEK_OF_YEAR'
          transform: 'WEEKOFYEAR({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isWeekOfYear
        - displayName: 'DAY_OF_YEAR'
          transform: 'DAYOFYEAR({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isYearColumn
        - displayName: 'QTR_OF_YEAR'
          transform: 'QUARTER({{ config.dateColumnName }})'
          dataType: SMALLINT
          placement: beginning
          attributeName: isYearColumn
      templates:
        create:
          templateString: |-
            {{ stage('Create Stage Table') }}
                CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}" {{ col.dataType }}
                        {%- if not col.nullable %} NOT NULL
                            {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                        {% endif %}
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
                {{ stage('Pre-SQL') }}
                {{ config.preSQL }}
            {% endif %}
            {% if config.truncateBefore %}
                {{ stage('Truncate Stage Table') }}
                TRUNCATE IF EXISTS {{ ref_no_link(node.location.name, node.name) }}
            {% endif %}
            {{ stage('Insert ' + sources[0].name | string ) }}
                INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in sources[0].columns %}
                        "{{ col.name }}"
                        {%- if not loop.last -%},{% endif %}
                    {% endfor %}
                )
                WITH CTE_DATE_GENERATOR AS (
                    SELECT DATEADD(DAY, SEQ4(), {{config.startingDate }}) AS {{ config.dateColumnName }}
                    FROM TABLE(GENERATOR(ROWCOUNT=>{{ config.daysToGenerate }}))
                )
                SELECT
                {% for col in sources[0].columns %}
                    {{ get_source_transform(col) }} AS "{{ col.name }}"
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
                FROM CTE_DATE_GENERATOR
            {% if config.postSQL %}
                {{ stage('Post-SQL') }}
                {{ config.postSQL }}
            {% endif %}
    name: Date Stage
    version: 1
  StepType-53:
    id: "53"
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |
        capitalized: Data Store
        short: DS
        plural: Data Stores
        tagColor: '#29B2DB'

        config:
        - groupName: Documentation
          items:
          - displayName: Description
            attributename: description
            type: textBox
            isRequired: false
            default: "Data Store Node\n\n
              This is a persistent table that requires a business key or natural key\n
              in order to process create and process.  Changing attributes can optionally be \n
              selected to track changes with a new system_start_time.\n\n
              Note: Failing to select a business will cause an error on Create or Run\n
              "
        - groupName: Options
          items:
          
          - type: businessKeyColumns
            isRequired: false

          - type: changeTrackingColumns
            isRequired: false

          - type: multisourceToggle
            enableIf: "{% if node.materializationType == 'table' %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            isRequired: false

        systemColumns:

        - displayName: SYSTEM_VERSION
          transform: ''
          dataType: NUMBER
          placement: end
          attributeName: isSystemVersion

        - displayName: SYSTEM_CURRENT_FLAG
          transform: ''
          dataType: VARCHAR
          placement: end
          attributeName: isSystemCurrentFlag

        - displayName: SYSTEM_START_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemStartDate

        - displayName: SYSTEM_END_DATE
          transform: CAST('2999-12-31 00:00:00' AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemEndDate

        - displayName: SYSTEM_CREATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: SYSTEM_UPDATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemUpdateDate
      templates:
        create:
          templateString: |+
            {{ stage('Create Data Store Table') }}

                CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}" {{ col.dataType }}
                        {% if col.isSurrogateKey %}
            		        identity
                        {% endif %}
                        {%- if not col.nullable %} NOT NULL
                            {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                        {% endif %}
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}


        run:
          templateString: |-

            {% set has_business_key = columns | selectattr("isBusinessKey") | list | length > 0 %}
            {% set is_type_2 = columns | selectattr("isChangeTracking") | list | length > 0 %}

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}
            	
                {% if has_business_key and is_type_2 %}

                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                        /* New Rows That Don't Exist */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_INITAL_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        LEFT JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                                {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "DIM"."{{ col.name }}" IS NULL
                        {% endfor %}
                        UNION ALL
                        /* New Row Needing To Be Inserted Due To Type-2 Column Changes */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                "DIM"."{{ col.name }}" + 1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_NEW_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Expired Due To Type-2 Column Changes
                        In this case, only two columns are merged (version and end date) */
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemEndDate %}
                                DATEADD(MILLISECONDS, -1, CAST(CURRENT_TIMESTAMP AS TIMESTAMP))
                            {% elif col.isSystemCurrentFlag %}
                                'N'
                            {% else %}
                                "DIM"."{{ col.name }}"
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'update_expired_version_rows' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Updated Due To Changes To Non-Type-2 source.columns
                        This case merges only when there are changes in non-type-2 column updates, but no changes in type-2 columns*/
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion or col.isSystemCreateDate or col.isSystemStartDate or col.isSystemEndDate %}
                                "DIM"."{{ col.name }}"
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                                {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'UPDATE_NON_TYPE2_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        AND (
                        {% for col in source.columns if (col.isChangeTracking) -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %} )
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isChangeTracking or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) -%}
                            {% if loop.first %}
                                AND (
                            {% endif %}
                            {% if not loop.first %}
                                OR
                            {% endif %}
                            NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                    ) AS "SRC"
                    ON
                    {% for col in source.columns if col.isBusinessKey -%}
                        {% if not loop.first %}
                            AND
                        {% endif %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                    {% endfor %}
                    AND "TGT"."{{ get_value_by_column_attribute("isSystemVersion") }}" = "SRC"."{{ get_value_by_column_attribute("isSystemVersion") }}"
                    WHEN MATCHED THEN UPDATE SET
                    {%- for col in source.columns if not (col.isBusinessKey or col.isSurrogateKey or col.isSystemCreateDate) %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    WHEN NOT MATCHED THEN INSERT (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )
                    VALUES (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )

                {% endfor %}

                {% elif has_business_key and not is_type_2 %}
                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string ) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                            SELECT
                            {% for col in source.columns if not col.isSurrogateKey %}
                                {% if col.isSystemVersion %}
                                	1
                                {% elif col.isSystemCurrentFlag %}
                                	'Y'
                                {% else %}
                                    {{ get_source_transform(col) }}
                                {% endif %}
                                AS "{{ col.name }}"
                                {%- if not loop.last %}, {% endif %}
                            {% endfor %}
                            {{ source.join }})
                            AS "SRC"
                        ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
                        {% endfor %}
                        WHEN MATCHED
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            NVL( CAST("SRC"."{{ col.name }}" as STRING), '**NULL**') <> NVL( CAST("TGT"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        THEN UPDATE SET
                        {%- for col in source.columns if not (  col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemCreateDate) %}
                                "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        WHEN NOT MATCHED THEN
                        INSERT (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                        VALUES (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                    {% endfor %}
                {% else %}
                    {% for source in sources %}
                        {{ stage('Insert ' + source.name | string ) }}
                        INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
                        (
                            {% for col in source.columns if not col.isSurrogateKey %}
                                "{{ col.name }}"
                                {%- if not loop.last -%},{% endif %}
                            {% endfor %}
                        )

                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}

                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                                {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}"
                            {%- if not loop.last -%}, {% endif %}
                            
                        {% endfor %}
                        {{ source.join }}
                    {% endfor %}            
                {% endif %}
            	
            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            	
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
    name: Data Store
    version: 1
  StepType-6:
    id: "6"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: HUB'
        short: 'HUB'
        tagColor: blue
        plural: 'DATAVAULT BY SCALEFREE: HUBS'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            enableIf: 'true'
            options: 
            - table
            default: table
         
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true

          - type: multisourceToggle

        - groupName: Data Vault
          items:

          - displayName: Hub Hash Key column
            type: columnSelector
            attributeName: is_Hub_hk
            isRequired: true
            enableIf: 'true'
            
          - displayName: Hub LoadDateTimestamp Column
            enableIf: 'false'
            type: columnSelector
            attributeName: is_Hub_ldts
            isRequired: false

          - displayName: Disable High-Water-Mark?
            type: toggleButton
            isRequired: false
            enableIf: 'false'
            attributeName: disable_hwm   
            default: true
            
      templates:
        create:
          templateString: |
            {{ stage('Create Hub Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
              {% for col in columns %}
                "{{ col.name }}" {{ col.dataType }}
                {%- if not col.nullable %} NOT NULL
                  {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                {% endif %}
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
              {{ stage('Pre-SQL') }}
              {{ config.preSQL }}
            {% endif %}

            {% for test in node.tests if config.testsEnabled %}
              {% if test.runOrder == 'Before' %}
                {{ test_stage(test.name, test.continueOnFailure) }}
                {{ test.templateString }}
              {% endif %}
            {% endfor %}

            {% for source in sources %}

              {{ stage('INSERT INTO Hub - ' ~ source.name) }}
              
              {%- set hashkey_column = get_value_by_column_attribute("is_Hub_hk") -%}
              
              {#-- enable when ColumnDropDownSelector is used again
              {%- if 'is_Hub_hk' not in config.keys() -%}

              {%- else -%}
                
                {%- set hashkey_column = config.is_Hub_hk.name -%}
              
              {%- endif -%}
              #}

              INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
              
            WITH incoming AS (

              SELECT DISTINCT
              {% for col in source.columns %}
                {{ get_source_transform(col) }} AS "{{ col.name }}"
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}

              {{ source.join }}

                {% if not config.disable_hwm -%}
                WHERE "{{ datavault4coalesce.config.ldts_alias }}" > (
                    SELECT 
                        COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
                    FROM {{ ref_no_link(node.location.name, node.name) }}
                 WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                    )
                {%- endif %}  

            ), 

            new_records AS (

              SELECT 
              "SRC".* 
              FROM incoming "SRC"
              WHERE NOT EXISTS 

              (SELECT 1 
              FROM {{ ref_no_link(node.location.name, node.name) }} "TGT"
              WHERE 
                "SRC"."{{ hashkey_column }}" = "TGT"."{{ hashkey_column }}")    

              QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) = 1
            )


              SELECT * FROM new_records

            {% endfor %}

            {% if config.postSQL %}
              {{ stage('Post-SQL') }}
              {{ config.postSQL }}
            {% endif %}

            {% if config.testsEnabled %}
              {% for test in node.tests %}
                {% if test.runOrder == 'After' %}
                  {{ test_stage(test.name, test.continueOnFailure) }}
                  {{ test.templateString }}
                    {% endif %}
              {% endfor %}

              {% for column in columns %}
                {% for test in column.tests %}
                  {{ test_stage(column.name + ": " + test.name) }}
                  {{ test.templateString }}
                {% endfor %}
              {% endfor %}
            {% endif %}
    name: "Datavault by Scalefree: Hub"
    version: 1
  StepType-61:
    id: "61"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Dynamic Table
        short: 'DYN'
        tagColor: '#C39BD3'
        isDisabled: false
        plural: Dynamic Tables

        deployStrategy: advanced

        config:
        - groupName: Options
          items: 
          - displayName: Lag
            attributeName: lagSchedule
            type: dropdownSelector
            default: "30 MINUTE"
            options:
            - "1 MINUTE"
            - "5 MINUTE"
            - "30 MINUTE"
            - "1 HOUR"
            - "1 DAY"
            isRequired: false
            
          - displayName: Warehouse
            attributeName: Warehouse
            type: dropdownSelector
            default: "COMPUTE_WH"
            options:
            - "COMPUTE_WH"
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: view
            options:
            - view
            isRequired: true
      templates:
        create:
          templateString: |-
            {% if desiredState == undefined %}

              {{ stage('Drop Dynamic Table') }}
              DROP DYNAMIC TABLE IF EXISTS {{ ref_no_link(currentState.node.location.name, currentState.node.name) }}

            {% else %}

              {% if currentState != desiredState %}

              {{ stage('(Re)Create Dynamic Table') }}

                CREATE OR REPLACE DYNAMIC TABLE {{ ref_no_link(desiredState.node.location.name, desiredState.node.name) }}
                  LAG = '{{ desiredState.config.lagSchedule }}'
                  WAREHOUSE = {{ desiredState.config.Warehouse }}
                AS
                  SELECT
                    {% for col in desiredState.sources[0].columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                      {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                  {{ desiredState.sources[0].join }}
              {% endif %}
            {% endif %}
        run:
          templateString: ""
    name: Dynamic Table
    version: 1
  StepType-7:
    id: "7"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: LINK'
        short: 'LINK'
        tagColor: 'Red'
        plural: 'DATAVAULT BY SCALEFREE: LINKS'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            enableIf: 'false'
            default: table
            options:
            - table

          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - type: multisourceToggle
          
        - groupName: Data Vault
          items:
          - displayName: Link Hashkey Column
            type: columnSelector
            attributeName: is_Link_hk
            isRequired: true 

          - displayName: Disable High-Water-Mark?
            type: toggleButton
            isRequired: false
            enableIf: 'false'
            attributeName: disable_hwm   
            default: true    
      templates:
        create:
          templateString: |-
            {{ stage('Create Link Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                    "{{ col.name }}" {{ col.dataType }}
                    {%- if not col.nullable %} NOT NULL
                        {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                    {% endif %}
                    {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if config.preSQL %}
                {{ stage('Pre-SQL') }}
                {{ config.preSQL }}

            {% endif %}

            {% for test in node.tests if config.testsEnabled %}
              {% if test.runOrder == 'Before' %}
                {{ test_stage(test.name, test.continueOnFailure) }}
                {{ test.templateString }}
              {% endif %}
            {% endfor %}

            {% for source in sources %}
                        
                {{ stage('INSERT INTO Link - ' ~ source.name) }}

                {#--USE AGAIN WHEN COLUMNDROPDOWNSELECTOR IS USED%- set link_hashkey = config.is_Link_hk.name -%#}

                {%- set link_hashkey = get_value_by_column_attribute("is_Link_hk") -%}
              

                INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH incoming AS 
                (
                    SELECT DISTINCT
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}

                    
                {% if not config.disable_hwm -%}
                WHERE "{{ datavault4coalesce.config.ldts_alias }}" > (
                    SELECT 
                        COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
                    FROM {{ ref_no_link(node.location.name, node.name) }}
                    )
                {%- endif %}
                ),

            new_records AS (
                SELECT
                    "SRC".*
                FROM incoming "SRC"
                WHERE NOT EXISTS (
                    SELECT
                        1
                    FROM {{ ref_no_link(node.location.name, node.name) }} "TGT"
                    WHERE "SRC"."{{ link_hashkey }}" = "TGT"."{{ link_hashkey }}"
                )

                QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ link_hashkey }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) = 1
            )

            SELECT * FROM new_records

            {% endfor %}

            {% if config.postSQL %}
                {{ stage('Post-SQL') }}
                {{ config.postSQL }}    
            {% endif %}

            {% if config.testsEnabled %}
              {% for test in node.tests %}
                {% if test.runOrder == 'After' %}
                  {{ test_stage(test.name, test.continueOnFailure) }}
                  {{ test.templateString }}
                    {% endif %}
              {% endfor %}

              {% for column in columns %}
                {% for test in column.tests %}
                  {{ test_stage(column.name + ": " + test.name) }}
                  {{ test.templateString }}
                {% endfor %}
              {% endfor %}
            {% endif %}
    name: "Datavault by Scalefree: Link"
    version: 1
  StepType-72:
    id: "72"
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: EXCEL FILE
        short: XLSX
        plural: Excel Files
        tagColor: 'green'
        config:
        - groupName: Options
          items:

          - displayName: Stage
            attributeName: stage
            type: dropdownSelector
            default: "DOUGS3"
            options:
            - "DOUGS3"
            - "TPCH"
            - "RefData"
            - "Logs"
            isRequired: true

          - displayName: Filename
            attributeName: filename
            type: textBox
            default: CUSTOMER.xlsx
            isRequired: true

          - displayName: Worksheet (empty will take the first sheet)
            attributeName: worksheet
            type: textBox
            isRequired: false

          - displayName: Number of rows to skip
            attributeName: skipRows
            default: "0"
            type: textBox
            isRequired: false
          
          - displayName: Columns to be used (eg. C:D)
            attributeName: useCols
            default: "A:E"
            type: textBox
            isRequired: false  

        systemColumns:
        - displayName: 'VALUE'
          attributeName: 'VALUE'
          transform: ''
          dataType: VARIANT
          placement: beginning
      templates:
        create:
          templateString: |-
            {{ stage('Create Python Procedure ') }}
            CREATE OR REPLACE PROCEDURE {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}(INPUT_DESTINATION_TABLE STRING, SKIP_ROWS INT, USE_COLS STRING)
              returns string not null
              language python
              runtime_version = '3.8'
              packages = ('snowflake-snowpark-python', 'pandas', 'openpyxl') -- openpyxl required for pandas to read xlsx
              imports = ('@DOUG_DB.PUBLIC.{{ config.stage | upper | trim }}/{{ config.filename | trim }}')
              handler = 'leverage_external_mapping_file_py'
            as
            $$
            import pandas
            import sys
            from snowflake.snowpark.functions import sql_expr
            IMPORT_DIRECTORY_NAME = "snowflake_import_directory"
            import_dir = sys._xoptions[IMPORT_DIRECTORY_NAME]
            def leverage_external_mapping_file_py(snowpark_session, destination_table: str, skip_rows: int, use_cols: str):
              mapping_df_pd = pandas.read_excel(import_dir + '{{ config.filename }}'{% if config.worksheet %},sheet_name="{{ config.worksheet }}"{% endif %}{% if config.skipRows %}, skiprows=skip_rows{% endif %}{%if config.useCols %}, usecols=use_cols{% endif %})
              json = mapping_df_pd.to_json(orient="records")
              df = snowpark_session.create_dataframe([json]).to_df("value")
              df = df.withColumn("value",sql_expr("parse_json(value)"))
              df.write.mode("overwrite").save_as_table(destination_table)
              return json
            $$
        run:
          templateString: |-
            {{ stage('Run Stored Procedure') }}
            CALL {{ ref_no_link(node.location.name, 'PROC_' + node.name | upper) | trim }}(
                '{{ this }}'
                ,{% if config.skipRows %}{{ config.skipRows }}{% else %}NULL{% endif %}
                ,{% if config.useCols %}'{{ config.useCols }}'{% else %}NULL{% endif %}
            )
    name: Excel File
    version: 1
  StepType-8:
    id: "8"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: 'DATAVAULT BY SCALEFREE: SATELLITE V0'
        short: 'SATV0'
        plural: 'DATAVAULT BY SCALEFREE: SATELLITES V0'
        tagColor: 'Yellow'


        config:
        - groupName: Data Vault
          items:
          - displayName: Hashkey Column
            type: columnSelector
            attributeName: is_hk
            isRequired: true

          - displayName: Hashdiff Column
            type: columnSelector
            attributeName: is_hd
            isRequired: true

          - displayName: Disable High-Water-Mark?
            type: toggleButton
            isRequired: true
            attributeName: disable_hwm   
            default: false    

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false
      templates:
        create:
          templateString: |
            {{ stage('Create Satellite Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
              {% for col in columns %}
                "{{ col.name }}" {{ col.dataType }}
                {%- if not col.nullable %} NOT NULL
                  {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                {% endif %}
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
              {% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |+
            {% if config.preSQL %}
              {{ stage('Pre-SQL') }}
              {{ config.preSQL }}
            {% endif %}

            {% for test in node.tests if config.testsEnabled %}
              {% if test.runOrder == 'Before' %}
                {{ test_stage(test.name, test.continueOnFailure) }}
                {{ test.templateString }}
              {% endif %}
            {% endfor %}

            {{ stage('Insert New Rows') }}
            INSERT INTO {{ ref_no_link(node.location.name, node.name) }}

            WITH latest_entries_in_sat AS (

              {#/* USE THIS again when ColumnDropdownSelector is used!
              {%- set hashkey_column = config.is_hk.name -%}
              {%- set hashdiff_column = config.is_hd.name -%}
              */#}

              {%- set hashkey_column = get_value_by_column_attribute("is_hk") -%}
              {%- set hashdiff_column = get_value_by_column_attribute("is_hd") -%}

              /* get current rows from satellite */
              SELECT 
                "{{ hashkey_column }}",
                "{{ hashdiff_column }}"
              FROM {{ ref_no_link(node.location.name, node.name) }} 
              QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" DESC) = 1


            ),

            deduplicated_numbered_source AS (
                
                {% for source in sources %}

                    SELECT
                {% for col in source.columns %}
                  {{ get_source_transform(col) }} AS {{ col.name }},
                {% endfor %}

                    ROW_NUMBER() OVER(PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}") as rn

                    
                    {{ source.join }}


                {% if not config.disable_hwm -%}
                WHERE "{{ datavault4coalesce.config.ldts_alias }}" > (
                  SELECT 
                    COALESCE(MAX("{{ datavault4coalesce.config.ldts_alias }}"),  {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.beginning_of_all_times) }})
                  FROM {{ ref_no_link(node.location.name, node.name) }}
                  WHERE "{{ datavault4coalesce.config.ldts_alias }}" != {{ datavault4coalesce__string_to_timestamp(datavault4coalesce.config.timestamp_format, datavault4coalesce.config.end_of_all_times) }}
                  )
                {%- endif %}  

                    QUALIFY
                    CASE
                        WHEN "{{ hashdiff_column }}" = LAG("{{ hashdiff_column }}") OVER(PARTITION BY "{{ hashkey_column }}" ORDER BY "{{ datavault4coalesce.config.ldts_alias }}" ) THEN FALSE
                        ELSE TRUE
                    END

                {% endfor %}

            )

              {% for source in sources %}
                SELECT DISTINCT
                {% for col in source.columns %}
                  {{ col.name }}
                  {%- if not loop.last -%}, {% endif %}
                {% endfor %}

                FROM deduplicated_numbered_source
              WHERE NOT EXISTS (
                SELECT 1 FROM latest_entries_in_sat
                WHERE 
                  deduplicated_numbered_source."{{ hashdiff_column }}" = latest_entries_in_sat."{{ hashdiff_column }}"
                AND deduplicated_numbered_source."{{ hashkey_column }}" = latest_entries_in_sat."{{ hashkey_column }}"

                    AND deduplicated_numbered_source.rn = 1
              )

              {% endfor %}

            {% if config.postSQL %}
              {{ stage('Post-SQL') }}
              {{ config.postSQL }}
            {% endif %}

            {% if config.testsEnabled %}
              {% for test in node.tests %}
                {% if test.runOrder == 'After' %}
                  {{ test_stage(test.name, test.continueOnFailure) }}
                  {{ test.templateString }}
                    {% endif %}
              {% endfor %}

              {% for column in columns %}
                {% for test in column.tests %}
                  {{ test_stage(column.name + ": " + test.name) }}
                  {{ test.templateString }}
                {% endfor %}
              {% endfor %}
            {% endif %}

    name: "Datavault by Scalefree: Satellite v0"
    version: 1
  StepType-80:
    id: "80"
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: SQL
        short: SQL
        tagColor: gray
        plural: sql

        config: 
        - groupName: Options 
          items: 
          - type: materializationSelector
            options:
              - table
            default: table
            isRequired: true
            isEnabled: "false"

          - displayName: SQL
            attributeName: SQLstmt 
            type: textBox 
            syntax: sql 
            isRequired: true    
            default: "  CREATE OR REPLACE TABLE DB.SCHEMA.TEST AS \n
            SELECT 1 COL"
         
        systemColumns: 
        - displayName: SYSTEM_START_DATE 
          transform: CURRENT_TIMESTAMP
          dataType: TIMESTAMP 
          placement: beginning 
          attributeName: isSQL
         
        - displayName: SQL_STMT
          transform: ''
          dataType: VARCHAR 
          placement: end 
          attributeName: isSystemStartDate 
         
      templates:
        create:
          templateString: |-
            {{ stage('Create SQL Table') }}

            CREATE OR REPLACE TABLE {{ this }}
            (
                {% for col in columns %}
                    "{{ col.name }}" {{ col.dataType }} 
                    {%- if not loop.last -%}, {% endif %}
                {% endfor %}
            )
        run:
          templateString: |-
            {% set sql = config.SQLstmt %}
            {% set sql_fix = sql | replace("'", "''") %}

            {{ stage('Insert SQL') }} 
            INSERT INTO {{ this }} (SYSTEM_START_DATE, SQL_STMT) 
            SELECT CURRENT_TIMESTAMP, '{{ sql_fix }}'; 

            {{ stage('Run SQL') }}
            {{ sql }}
    name: SQL
    version: 1
  StepType-81:
    id: "81"
    isDisabled: true
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |+
        capitalized: Aggregate View
        short: VAGG
        tagColor: '#C4C4C4'
        isDisabled: true
        plural: Views

        config:
          - groupName: Options
            items: 

            - displayName: COUNT DISTINCT
              type: columnSelector
              attributeName: isCountDistinct
              isRequired: false

            - displayName: SUM
              type: columnSelector
              attributeName: isSum
              isRequired: false
            
            - displayName: MIN
              type: columnSelector
              attributeName: isMin
              isRequired: false

            - displayName: MAX
              type: columnSelector
              attributeName: isMax
              isRequired: false

            - displayName: AVG
              type: columnSelector
              attributeName: isAvg
              isRequired: false

            - type: materializationSelector
              options:
                - view
              default: view
              isRequired: true
              enableIf: "false"

        systemColumns: 
        - displayName: RECORD_COUNT 
          transform: COUNT(*)
          dataType: INTEGER
          placement: end 
          attributeName: isCount

      templates:
        create:
          templateString: |+
            {% set source = sources[0] %}
            {{ stage('Create View') }}
            CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}"
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                AS
                SELECT 
                    {% for col in source.columns %}
                        {% if col.isSum  %}
                            SUM({{ get_source_transform(col) }})
                        {% elif col.isCountDistinct %}
                            COUNT(DISTINCT {{ get_source_transform(col) }})
                        {% elif col.isMin %}
                             MIN({{ get_source_transform(col) }})
                        {% elif col.isMax %}
                            MAX({{ get_source_transform(col) }})
                        {% elif col.isAvg %}
                            AVG({{ get_source_transform(col) }})
                        {% else %}
                            {{ get_source_transform(col) }}
                        {% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                {{ source.join }}
                GROUP BY 
                    {% for col in source.columns if not col.isSum and not col.isMin and not col.isMax and not col.isAvg and not col.isCountDistinct and not col.isCount -%}
                        {{ get_source_transform(col) }} {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

        run:
          templateString: ""
    name: Aggregate View
    version: 1
  StepType-85:
    id: "85"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: Snowpipe
        short: 'LOAD'
        tagColor: '#C39BD3'
        isDisabled: false
        plural: Snowpipe

        config:
        - groupName: File Location
          items: 

          - displayName: Stage
            attributeName: fileLocation
            type: dropdownSelector
            default: "DOUGS3"
            options:
            - "DOUGS3"
            - "Create external stages on Snowflake"
            - "Place them in the same storage location"
            - "List the storage locations in this dropdown"
            isRequired: true

          - displayName: File Pattern
            attributeName: filePattern
            type: textBox
            default: ".*[.]json"
            isRequired: true

        - groupName: File Format 
          items:
          - displayName: File Type
            attributeName: fileType
            type: dropdownSelector
            default: JSON
            options:
            - "CSV"
            - "JSON"
            - "Parquet"
            isRequired: true

          - displayName: Compression
            attributeName: compression
            enableIf: "{{ config.fileType in ['CSV','JSON'] }}" 
            type: dropdownSelector
            options:
            - "AUTO"
            - "GZIP"
            - "BZ2"
            - "BROTLI"
            - "ZSTD"
            - "DEFLATE"
            - "RAW_DEFLATE"
            - "NONE"
            isRequired: false

          - displayName: Record delimiter
            attributeName: recDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\n"
            isRequired: false

          - displayName: Field delimiter
            attributeName: fieldDelim
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: ","
            isRequired: false

          - displayName: Field optionally enclosed by
            attributeName: fieldEnclosed
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "\\042"
            isRequired: false

          - displayName: Number of header lines to skip
            attributeName: skipHeader
            type: textBox
            enableIf: "{{ config.fileType == 'CSV'}}" 
            default: "1"
            isRequired: false

          - displayName: Skip blank lines
            attributeName: skipBlankLines
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

          - displayName: Trim space
            attributeName: trimSpace
            enableIf: "{{ config.fileType == 'CSV'}}" 
            type: toggleButton
            default: true
            isRequired: false

        - groupName: Additional Options
          items:
          - displayName: Auto Ingest
            attributeName: autoIngest
            type: toggleButton
            default: true
            isRequired: false

          - displayName: AWS SNS Topic
            attributeName: snsTopic
            type: textBox
            enableIf: "{{ config.autoIngest }}"
            default: "arn:aws:sns:us-east-1:121674918127:prod-emea-s3-notification"
            isRequired: false

        - groupName: Hidden config
          enableIf: "false"
          items:
          - displayName: Type
            type: materializationSelector
            default: table
            options:
            - table
            isRequired: true

        systemColumns:
        - displayName: 'VALUE'
          attributeName: 'VALUE'
          transform: ''
          dataType: VARIANT
          placement: beginning
        - displayName: 'METADATA$FILENAME'
          attributeName: 'METADATA$FILENAME'
          transform: ''
          dataType: STRING
          placement: end
      templates:
        create:
          templateString: |+
            {% set source = sources[0] %}

            {{ stage('Create Landing table')}}
            CREATE OR REPLACE TABLE {{this}}
              {% if config.fileType == "CSV" %}
                {% for col in source.columns if (col.name | upper != "VALUE" and col.name | upper != "METADATA$FILENAME") %}
                  {% if loop.first %}({% endif %}
                    "{{ col.name }}" {{ col.dataType }} AS (value:c{{ loop.index }}::{{ col.dataType }})
                  {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                  {%- if not loop.last -%}, {% else %}){% endif %}
                {% endfor %}
              {% endif %}
              {% for col in source.columns if (col.name | upper == "VALUE" or col.name | upper == "METADATA$FILENAME") %}
                {% if loop.first %}({% endif %}
                  "{{ col.name }}" {{ col.dataType }} 
                {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
                {%- if not loop.last -%}, {% else %}){% endif %}
              {% endfor %}

            {{ stage('Create Snowpipe') }}
            CREATE OR REPLACE PIPE  {{ this | replace (node.name, "PIPE_"+node.name) }}
              auto_ingest = true
              
            AS
              COPY INTO {{ this }} (VALUE)
              FROM  @{{parameters.stage_location}}.{{ config.fileLocation | upper  }}
              FILE_FORMAT = (TYPE = '{{ config.fileType }}');

        run:
          templateString: ""
    name: Snowpipe
    version: 1
  StepType-9:
    id: "9"
    isDisabled: true
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |-
        capitalized: Satellite User-Defined
        short: 'SAT'
        plural: 'Satellites'
        tagColor: 'yellow'

        config:
        - groupName: Options
          items:
          - displayName: Hub Hash Column
            type: columnSelector
            attributeName: isHubHash
            isRequired: true

          - displayName: Change Hash Column
            type: columnSelector
            attributeName: isChangeHash
            isRequired: true

        - groupName: Pre/Post SQL
          items:
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
          
          
      templates:
        create:
          templateString: |

            {{ stage('Create Satellite Table') }}

            CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            (
            	{% for col in columns %}
            		"{{ col.name }}" {{ col.dataType }}
            		{%- if not col.nullable %} NOT NULL
            			{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            		{% endif %}
            		{%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
            		{%- if not loop.last -%}, {% endif %}
            	{% endfor %}
            )
            {%- if node.description | length > 0 %} COMMENT = '{{ node.description }}'{% endif %}
        run:
          templateString: |-
            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}

            	{{ stage('Insert New Rows') }}
            	INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            	WITH "SAT_CURR_ROWS" AS (
            		/* get current rows from satellite */
            		{% for col in columns if col.isHubHash or col.isChangeHash %}
            			{%- if loop.first -%}SELECT {% endif %} 
            			{{col.name}}
            			{%- if not loop.last -%}, {% endif %}
            			{%- if loop.last %} 
            				FROM {{ ref_no_link(node.location.name, node.name) }} 
            				QUALIFY ROW_NUMBER() OVER (PARTITION BY "{{ get_value_by_column_attribute("isHubHash") }}" ORDER BY "{{ get_value_by_column_attribute("isSystemCreateDate") }}" DESC) = 1
            			{% endif %}
            		{% endfor %}
            	)

            		{% for source in sources %}
            			SELECT DISTINCT
            			{% for col in source.columns %}
            				{{ get_source_transform(col) }} AS "{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}

            			{{ source.join }}
            		WHERE NOT EXISTS(
            			SELECT 1 FROM "SAT_CURR_ROWS"
            			WHERE 
            			{% for col in source.columns if col.isHubHash or col.isChangeHash %}
            				{% if not loop.first %}
            					AND
            				{% endif %}
            				{{ get_source_transform(col) }} = "SAT_CURR_ROWS"."{{ col.name }}"
            			{% endfor %}
            		)

            		{% endfor %}

            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}

            {% endif %}
    name: Satellite
    version: 1
  StepType-98:
    id: "98"
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |-
        capitalized: Copy of Copy Into
        short: 'COPY'
        tagColor: '#6ca37b'
        isDisabled: false
        plural: Copy Into
        config:
        - groupName: Source Data
          items:
          - displayName: Stage Name
            attributeName: stageName
            type: textBox
            default: 'DOUGS32'
            isRequired: true

          - displayName: File Name(s) (Optional - Use single quotes and commas)
            attributeName: fileNames
            type: textBox
            isRequired: false

          - displayName: File Pattern (Optional - Use single quotes)
            attributeName: filePattern
            type: textBox
            isRequired: false

        - groupName: File Format
          items:
          - displayName: File Format Definition
            attributeName: fileFormatType
            type: dropdownSelector
            default: "File Format Name"
            options:
            - File Format Name
            - File Format Values
          - displayName: File Format Name
            attributeName: fileFormatName
            type: textBox
            default: ""
            isRequired: false
            enableIf: "{% if config.fileFormatType == 'File Format Name' %} true {% else %} false {% endif %}"
          - displayName: File Type
            attributeName: fileType
            type: dropdownSelector
            default: CSV
            options:
            - "CSV"
            - "PARQUET"
            - "JSON"
            - "AVRO"
            - "ORC"
            - "XML"
            isRequired: false
            enableIf: "{% if config.fileFormatType != 'File Format Name' %} true {% else %} false {% endif %}"
          - displayName: Compression
            attributeName: compression
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV','JSON')) %} true {% else %} false {% endif %}"
            type: dropdownSelector
            default: "AUTO"
            options:
            - "AUTO"
            - "GZIP"
            - "BZ2"
            - "BROTLI"
            - "ZSTD"
            - "DEFLATE"
            - "RAW_DEFLATE"
            - "NONE"
            isRequired: false
          - displayName: Record delimiter
            attributeName: recDelim
            type: textBox
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            default: "\n"
            isRequired: false
          - displayName: Field delimiter
            attributeName: fieldDelim
            type: textBox
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            default: ","
            isRequired: false
          - displayName: Field optionally enclosed by
            attributeName: fieldEnclosed
            type: textBox
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            default: "\\042"
            isRequired: false
          - displayName: Number of header lines to skip
            attributeName: skipHeader
            type: textBox
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            default: "1"
            isRequired: false
          - displayName: Skip blank lines
            attributeName: skipBlankLines
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            type: toggleButton
            default: true
            isRequired: false
          - displayName: Trim space
            attributeName: trimSpace
            enableIf: "{% if (config.fileFormatType != 'File Format Name' and config.fileType in ('CSV')) %} true {% else %} false {% endif %}"
            type: toggleButton
            default: true
            isRequired: false
        - groupName: Copy Options
          items:
          - displayName: Truncate Target Flag
            attributeName: truncateTargetFlag
            type: toggleButton
            isRequired: true
            default: false
          - displayName: On Error Behavior
            attributeName: onError
            type: dropdownSelector
            options:
            - "CONTINUE"
            - "SKIP_FILE"
            - "SKIP_FILE_<num>"
            - "SKIP_FILE_<num>%"
            - "ABORT_STATEMENT"
            isRequired: false
          - displayName: Size Limit
            attributeName: sizeLimit
            type: textBox
            isRequired: false
          - displayName: Purge Behavior
            attributeName: purgeBehavior
            type: dropdownSelector
            default: FALSE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
          - displayName: Return Failed Only
            attributeName: returnFailedOnly
            type: dropdownSelector
            default: FALSE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
          - displayName: Match By Column Name
            attributeName: matchByColumnName
            type: dropdownSelector
            default: NONE
            options:
            - "CASE_SENSITIVE"
            - "CASE_INSENSITIVE"
            - "NONE"
            isRequired: false
            enableIf: "{% if config.fileType in ('JSON','AVRO','ORC','PARQUET') %} true {% else %} false {% endif %}"
          - displayName: Enforce Length
            attributeName: enforceLength
            type: dropdownSelector
            default: TRUE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
          - displayName: Truncate Columns
            attributeName: truncateColumns
            type: dropdownSelector
            default: FALSE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
          - displayName: Force
            attributeName: forceLoad
            type: dropdownSelector
            default: FALSE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
          - displayName: Load Uncertain Files
            attributeName: loadUncertainFiles
            type: dropdownSelector
            default: FALSE
            options:
            - "TRUE"
            - "FALSE"
            isRequired: false
      templates:
        create:
          templateString: |
            { stage('Create Table') }}
            CREATE OR REPLACE TABLE {{this}} (
                {% for col in columns %}
                    "{{ col.name }}" {{ col.dataType }}
                {%- if col.Description | length > 0 %} COMMENT '{{ col.Description }}'{% endif %}
                {%- if not loop.last -%}, {% endif %}
            {% endfor %}
            )
        run:
          templateString: |-
            {% set srcSchName = node.location.name %}
            {% set db = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
            {% set sch = storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}


            {%- if config.filePattern | length > 0 -%} 
                {%- set filePatternSQL = 'PATTERN = ' + config.filePattern -%} 
            {%- else -%}
                {%- set filePatternSQL = "" -%} 
            {%- endif -%}

            {%- if config.fileNames | length > 0 %} 
                {% set fileNameSQL = 'FILES = (' + config.fileNames + ')' %} 
            {%- else -%}
                {% set fileNameSQL = "" %} 
            {% endif %}

            {{ stage('Copy Into') }}
                COPY INTO {{this}} (
                    {%- for col in columns %}
                        "{{ col.name }}"
                    {%- if not loop.last -%}, {% endif %}
                    {%- endfor %}
                )
                FROM (SELECT
                    {%- for col in sources[0].columns %}
                        {{ col.transform }}
                    {%- if not loop.last -%}, {% endif %}
                    {%- endfor %}
                     FROM '@{{parameters.stage_location}}.{{ config.stageName }}') 
                {{- fileNameSQL }}
                {{ filePatternSQL }}
                FILE_FORMAT = (FORMAT_NAME = '{{ db }}.{{ sch }}.{{ config.fileFormatName}}')
    name: Copy Into
    version: 1
  StepType-Dimension:
    id: Dimension
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |-
        capitalized: Dimension
        short: DIM
        tagColor: '#1E339A'
        plural: Dimensions

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table
            - view

          - type: multisourceToggle
            enableIf: "{% if node.materializationType == 'table' %} true {% else %} false {% endif %}"

          - type: businessKeyColumns
            isRequired: true

          - type: changeTrackingColumns
            isRequired: false

          - type: overrideSQLToggle
            enableIf: "{% if node.materializationType == 'view' %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: '{{NODE_NAME}}_KEY'
          transform: ''
          dataType: NUMBER
          placement: beginning
          attributeName: isSurrogateKey

        - displayName: SYSTEM_VERSION
          transform: ''
          dataType: NUMBER
          placement: end
          attributeName: isSystemVersion

        - displayName: SYSTEM_CURRENT_FLAG
          transform: ''
          dataType: VARCHAR
          placement: end
          attributeName: isSystemCurrentFlag

        - displayName: SYSTEM_START_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemStartDate

        - displayName: SYSTEM_END_DATE
          transform: CAST('2999-12-31 00:00:00' AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemEndDate

        - displayName: SYSTEM_CREATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: SYSTEM_UPDATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemUpdateDate
      templates:
        create:
          templateString: |
            {% if node.materializationType == 'table' %}
            	{{ stage('Create Dimension Table') }}

            	CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}" {{ col.dataType }}
            			{% if col.isSurrogateKey %}
            		        identity
            			{% endif %}
            			{%- if not col.nullable %} NOT NULL
            				{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            			{% endif %}
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}


            {% elif node.materializationType == 'view' %}
            	{{ stage('Create Dimension View') }}

            	CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}"
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%},{% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            	AS
            	{% for source in sources %}

            		{% if loop.first %}SELECT {% endif %}

            		{% for col in source.columns %}
            			{% if col.isSurrogateKey or col.isSystemUpdateDate or col.isSystemCreateDate %}
                            NULL
            			{% else %}
                            {{ get_source_transform(col) }}
            			{% endif %}
            			AS "{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            		{{ source.join }}

            		{% if not loop.last %} UNION ALL {% endif %}
            	{% endfor %}

            {% endif %}
        run:
          templateString: |

            {% set is_type_2 = columns | selectattr("isChangeTracking") | list | length > 0 %}

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}

            	{% if config.preSQL %}			
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}
            	
                {% if is_type_2 %}

                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                        /* New Rows That Don't Exist */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_INITAL_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        LEFT JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                                {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "DIM"."{{ col.name }}" IS NULL
                        {% endfor %}
                        UNION ALL
                        /* New Row Needing To Be Inserted Due To Type-2 Column Changes */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                "DIM"."{{ col.name }}" + 1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_NEW_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Expired Due To Type-2 Column Changes
                        In this case, only two columns are merged (version and end date) */
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemEndDate %}
                                DATEADD(MILLISECONDS, -1, CAST(CURRENT_TIMESTAMP AS TIMESTAMP))
                            {% elif col.isSystemCurrentFlag %}
                                'N'
                            {% else %}
                                "DIM"."{{ col.name }}"
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'update_expired_version_rows' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        {# The if-block below avoids unnecessary updates when no type 2 column changes are present #}
                        {% if source.columns 
                            | rejectattr('isSurrogateKey')
                            | rejectattr('isBusinessKey')
                            | rejectattr('isChangeTracking')
                            | rejectattr('isSystemVersion')
                            | rejectattr('isSystemCurrentFlag')
                            | rejectattr('isSystemStartDate')
                            | rejectattr('isSystemEndDate')
                            | rejectattr('isSystemCreateDate')
                            | rejectattr('isSystemUpdateDate') 
                            | list | length == 0 
                        %}
                            {# Skip Section #}
                        {% else %}
                          UNION ALL
                          /* Rows Needing To Be Updated Due To Changes To Non-Type-2 columns
                          This case merges only when there are changes in non-type-2 column updates, but no changes in type-2 columns*/
                          SELECT
                          {%- for col in source.columns if not col.isSurrogateKey %}
                              {% if col.isSystemVersion or col.isSystemCreateDate or col.isSystemStartDate or col.isSystemEndDate %}
                                  "DIM"."{{ col.name }}"
                              {% elif col.isSystemCurrentFlag %}
                                  'Y'
                              {% else %}
                                  {{ get_source_transform(col) }}
                              {% endif %}
                              AS "{{ col.name }}",
                          {% endfor -%}
                              'UPDATE_NON_TYPE2_ROWS' AS "DML_OPERATION"
                          {{ source.join }}
                          INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                          {% for col in source.columns if col.isBusinessKey -%}
                              {% if not loop.first %}
                                  AND
                              {% endif %}
                              {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                          {% endfor %}
                          WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                          AND (
                          {% for col in source.columns if (col.isChangeTracking) -%}
                              {% if not loop.first %}
                                  AND
                              {% endif %}
                              {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                          {% endfor %} )
                          {% for col in source.columns if not (   col.isBusinessKey or
                                                                  col.isChangeTracking or
                                                                  col.isSurrogateKey or
                                                                  col.isSystemVersion or
                                                                  col.isSystemCurrentFlag or
                                                                  col.isSystemStartDate or
                                                                  col.isSystemEndDate or
                                                                  col.isSystemUpdateDate or
                                                                  col.isSystemCreateDate) -%}
                              {% if loop.first %}
                                  AND (
                              {% endif %}
                              {% if not loop.first %}
                                  OR
                              {% endif %}
                              NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**')
                              {% if loop.last %}
                                  )
                              {% endif %}
                          {% endfor %}
                        {% endif %}
                    ) AS "SRC"
                    ON
                    {% for col in source.columns if col.isBusinessKey -%}
                        {% if not loop.first %}
                            AND
                        {% endif %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                    {% endfor %}
                    AND "TGT"."{{ get_value_by_column_attribute("isSystemVersion") }}" = "SRC"."{{ get_value_by_column_attribute("isSystemVersion") }}"
                    WHEN MATCHED THEN UPDATE SET
                    {%- for col in source.columns if not (col.isBusinessKey or col.isSurrogateKey or col.isSystemCreateDate) %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    WHEN NOT MATCHED THEN INSERT (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )
                    VALUES (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )

                {% endfor %}



                {% else %}
                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string ) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                            SELECT
                            {% for col in source.columns if not col.isSurrogateKey %}
                                {% if col.isSystemVersion %}
                                	1
                                {% elif col.isSystemCurrentFlag %}
                                	'Y'
                                {% else %}
                                    {{ get_source_transform(col) }}
                                {% endif %}
                                AS "{{ col.name }}"
                                {%- if not loop.last %}, {% endif %}
                            {% endfor %}
                            {{ source.join }})
                            AS "SRC"
                        ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
                        {% endfor %}
                        WHEN MATCHED
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            NVL( CAST("SRC"."{{ col.name }}" as STRING), '**NULL**') <> NVL( CAST("TGT"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        THEN UPDATE SET
                        {%- for col in source.columns if not (  col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemCreateDate) %}
                                "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        WHEN NOT MATCHED THEN
                        INSERT (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                        VALUES (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                    {% endfor %}
                {% endif %}
            	
            	{% if config.postSQL %}			
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
    name: Dimension
    version: 1
  StepType-Fact:
    id: Fact
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |
        capitalized: Fact
        plural: Facts
        short: FCT
        tagColor: '#D9A438'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            options:
            - table
            - view
          
          - type: businessKeyColumns
            isRequired: false

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: SYSTEM_CREATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: SYSTEM_UPDATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemUpdateDate
      templates:
        create:
          templateString: |2-

                {% if node.materializationType == 'table' %}
                    {{ stage('Create Fact Table') }}
                
                    CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
                    (
                        {% for col in columns %}
                            "{{ col.name }}" {{ col.dataType }}
                            {%- if not col.nullable %} NOT NULL
                                {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                            {% endif %}
                            {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                            {%- if not loop.last -%}, {% endif %}
                        {% endfor %}
                    )
                    {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                
                
                {% elif node.materializationType == 'view' %}
                    {{ stage('Create Fact View') }}
                
                    CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                    (
                        {% for col in columns %}
                            "{{ col.name }}"
                            {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                            {%- if not loop.last -%},{% endif %}
                        {% endfor %}
                    )
                    {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                    AS
                    {% for source in sources %}
                
                        {% if loop.first %}SELECT {% endif %}
                
                        {% for col in source.columns %}
                            {{ get_source_transform(col) }} AS "{{ col.name }}"
                            {%- if not loop.last -%}, {% endif %}
                        {% endfor %}
                        {{ source.join }}
                
                        {% if not loop.last %} UNION ALL {% endif %}
                    {% endfor %}
                
                {% endif %}
                
        run:
          templateString: |2-

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

                {% if node.materializationType == 'table' %}
                    {% if config.preSQL %}
                        {{ stage('Pre-SQL') }}
                        {{ config.preSQL }}
                    {% endif %}
                    
                    {% set has_business_key = columns | selectattr("isBusinessKey") | list | length > 0 %}
                    
                    {% for source in sources %}
                    
                        {% if has_business_key %}
                    
                            {{ stage('MERGE ' + source.name | string ) }}
                            MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                            USING (
                                SELECT
                                {% for col in source.columns %}
                                    {{ get_source_transform(col) }} AS "{{ col.name }}"
                                    {%- if not loop.last %}, {% endif %}
                                {% endfor %}
                                {{ source.join }})
                                AS "SRC"
                            ON
                            {% for col in source.columns if col.isBusinessKey -%}
                                {% if not loop.first %}
                                    AND
                                {% endif %}
                                "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
                            {% endfor %}
                            WHEN MATCHED
                            {% for col in source.columns if not (   col.isBusinessKey or
                                                                    col.isSystemUpdateDate or
                                                                    col.isSystemCreateDate) %}
                                {% if loop.first %}
                                    AND (
                                {% else %}
                                    OR
                                {% endif %}
                                NVL( CAST("SRC"."{{ col.name }}" as STRING), '**NULL**') <> NVL( CAST("TGT"."{{ col.name }}" as STRING), '**NULL**')
                                {% if loop.last %}
                                    )
                                {% endif %}
                            {% endfor %}
                            THEN UPDATE SET
                            {%- for col in source.columns if not (col.isBusinessKey or col.isSystemCreateDate) %}
                                    "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                                {% if not loop.last %}, {% endif %}
                            {% endfor %}
                            WHEN NOT MATCHED THEN
                            INSERT (
                            {%- for col in source.columns if not col.isSurrogateKey %}
                                "{{ col.name }}"
                                {% if not loop.last %}, {% endif %}
                            {% endfor -%}
                            )
                            VALUES (
                            {%- for col in source.columns if not col.isSurrogateKey %}
                                "SRC"."{{ col.name }}"
                                {% if not loop.last %}, {% endif %}
                            {% endfor -%}
                            )
                    
                        {% else %}
                    
                            {{ stage('Insert ' + source.name | string ) }}
                    
                                INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
                                (
                                    {% for col in source.columns %}
                                        "{{ col.name }}"
                                        {%- if not loop.last -%},{% endif %}
                                    {% endfor %}
                                )
                    
                                SELECT
                                {% for col in source.columns %}
                                    {{ get_source_transform(col) }} AS "{{ col.name }}"
                                    {%- if not loop.last -%}, {% endif %}
                                {% endfor %}
                                {{ source.join }}
                        {% endif %}
                    {% endfor %}
                    {% if config.postSQL %}
                        {{ stage('Post-SQL') }}
                        {{ config.postSQL }}
                    {% endif %}
                {% endif %}

                {% if config.testsEnabled %}
                    {% for test in node.tests %}
                        {% if test.runOrder == 'After' %}
                            {{ test_stage(test.name, test.continueOnFailure) }}
                            {{ test.templateString }}
                        {% endif %}
                    {% endfor %}

                    {% for column in columns %}
                        {% for test in column.tests %}
                            {{ test_stage(column.name + ": " + test.name) }}
                            {{ test.templateString }}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
                
                
    name: Fact
    version: 1
  StepType-Hub:
    id: Hub
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: Hub
        short: 'HUB'
        plural: 'Hubs'

        tagColor: '#92712E'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            options: 
            - table
            default: table

          - displayName: Multi Source Strategy
            attributeName: insertStrategy
            type: dropdownSelector
            default: UNION
            options:
            - "UNION"
            - "UNION ALL"
            isRequired: true
            enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |-
            {% if node.materializationType == 'table' %}
            				{{ stage('Create Hub Table') }}
            			
            				CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}" {{ col.dataType }}
            						{%- if not col.nullable %} NOT NULL
            							{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            						{% endif %}
            						{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            						{%- if not loop.last -%}, {% endif %}
            					{% endfor %}
            				)
            				{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            			
            			{% endif %}
        run:
          templateString: |2-

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}


            	{{ stage('Merge Hub') }}
            	MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
            	(
            		{% for source in sources %}
            		SELECT
            		{% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}

            		{{ source.join }}

            		{% if not loop.last %}
            			{{ config.insertStrategy }}
            		{% endif %}
            	{% endfor %}
            	)
            	AS "SRC"
            	ON
            	{% for col in sources[0].columns if (col.sourceColumns[0] 
                                                    and col.sourceColumns[0].column 
                                                    and col.sourceColumns[0].column.isHubHash
                                                    ) -%}
            		{% if not loop.first %}
            			AND
            		{% endif %}
            		"SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
            	{% endfor %}
            	WHEN NOT MATCHED THEN
            	INSERT
            	(
            		{% for col in columns %}
            			"{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	) VALUES
            	(
            		{% for col in columns %}
            			"SRC"."{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)


            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            	
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
            			
    name: Hub
    version: 1
  StepType-Link:
    id: Link
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: Link
        short: 'LNK'
        plural: 'Links'
        tagColor: '#CA2287'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table

          - displayName: Multi Source Strategy
            attributeName: insertStrategy
            type: dropdownSelector
            default: UNION
            options:
            - "UNION"
            - "UNION ALL"
            isRequired: true
            enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |-
            {% if node.materializationType == 'table' %}
            				{{ stage('Create Link Table') }}
            			
            				CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}" {{ col.dataType }}
            						{%- if not col.nullable %} NOT NULL
            							{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            						{% endif %}
            						{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            						{%- if not loop.last -%}, {% endif %}
            					{% endfor %}
            				)
            				{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            			
            			{% endif %}
        run:
          templateString: |2-

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	
            	{% endif %}

            			
            	{{ stage('Merge Link') }}
            	MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
            	(
            		{% for source in sources %}
            		SELECT
            		{% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}

            		{{ source.join }}

            		{% if not loop.last %}
            			{{ config.insertStrategy }}
            		{% endif %}
            	{% endfor %}
            	)
            	AS "SRC"
            	ON
            	{% for col in sources[0].columns if (col.sourceColumns[0] 
                                                    and col.sourceColumns[0].column 
                                                    and col.sourceColumns[0].column.isLinkHash
                                                    ) -%}
            		{% if not loop.first %}
            			AND
            		{% endif %}
            		"SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
            	{% endfor %}
            	WHEN NOT MATCHED THEN
            	INSERT
            	(
            		{% for col in columns %}
            			"{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	) VALUES
            	(
            		{% for col in columns %}
            			"SRC"."{{ col.name }}"
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)

            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}	
            	{% endif %}
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
            			
    name: Link
    version: 1
  StepType-Satellite:
    id: Satellite
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: Satellite
        short: 'SAT'
        plural: 'Satellites'
        tagColor: '#627DE9'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table

          - displayName: Multi Source Strategy
            attributeName: insertStrategy
            type: dropdownSelector
            default: UNION
            options:
            - "UNION"
            - "UNION ALL"
            isRequired: true
            enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:
        - displayName: "LOAD_DATE"
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: "RECORD_SOURCE"
          transform: "''"
          dataType: VARCHAR
          placement: end
          attributeName: isSystemRecordSource
      templates:
        create:
          templateString: |-
            {% if node.materializationType == 'table' %}
            				{{ stage('Create Satellite Table') }}
            			
            				CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}" {{ col.dataType }}
            						{%- if not col.nullable %} NOT NULL
            							{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            						{% endif %}
            						{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            						{%- if not loop.last -%}, {% endif %}
            					{% endfor %}
            				)
            				{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
            			
            			{% endif %}
        run:
          templateString: |2-

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            		{% if config.preSQL %}
            			{{ stage('Pre-SQL') }}
            			{{ config.preSQL }}
            		{% endif %}
            	
            		{{ stage('Merge Satellite') }}
            		MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
            		(
            			{% for source in sources %}
            			SELECT
            			{% for col in source.columns %}
                            {{ get_source_transform(col) }} AS "{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}
            	
            			{{ source.join }}
            	
            			{% if not loop.last %}
            				{{ config.insertStrategy }}
            			{% endif %}
            		{% endfor %}
            		)
            		AS "SRC"
            		ON
            		{% for col in sources[0].columns if (col.sourceColumns[0] 
                                                        and col.sourceColumns[0].column 
                                                        and col.sourceColumns[0].column.isChangeHash
                                                        ) -%}
            			{% if not loop.first %}
            				AND
            			{% endif %}
            			"SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
            		{% endfor %}
            		WHEN NOT MATCHED THEN
            		INSERT
            		(
            			{% for col in columns %}
            				"{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}
            		) VALUES
            		(
            			{% for col in columns %}
            				"SRC"."{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}
            		)
            	
            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}	
            	{% endif %}
            	
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
            			
    name: Satellite
    version: 1
  StepType-Source:
    id: Source
    isDisabled: false
    metadata:
      defaultStorageLocation: null
      error: null
      nodeMetadataSpec: |-
        capitalized: Source
        short: null
        tagColor: '#D26000'
        plural: Sources
      templates:
        create:
          templateString: |
            {{ stage('Validating Source Exists') }}
            SELECT 1 FROM {{ ref(node.location.name, node.name) }} LIMIT 0
        run:
          templateString: |
            {{ stage('Validating Source Exists') }}
            SELECT 1 FROM {{ ref(node.location.name, node.name) }} LIMIT 0
    name: Source
    version: 1
  StepType-Stage:
    id: Stage
    isDisabled: false
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Stage
        short: STG
        plural: Stages
        tagColor: '#2EB67D'

        config:
        - groupName: Options
          items:
          - type: materializationSelector
            default: table
            options:
            - table
            - view
            isRequired: true

          - type: multisourceToggle
            enableIf: "{% if node.materializationType == 'table' %} true {% else %} false {% endif %}" 

          - type: overrideSQLToggle
            enableIf: "{% if node.materializationType == 'view' %} true {% else %} false {% endif %}"
            
          - displayName: Multi Source Strategy
            attributeName: insertStrategy
            type: dropdownSelector
            default: INSERT
            options:
            - "INSERT"
            - "UNION"
            - "UNION ALL"
            isRequired: true
            enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"

          - displayName: Truncate Before
            attributeName: truncateBefore
            type: toggleButton
            default: true

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false
      templates:
        create:
          templateString: |
            {% if node.override.create.enabled %}
            	
            	{{ node.override.create.script }}

            {% elif node.materializationType == 'table' %}
            	{{ stage('Create Stage Table') }}

            	CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
            	(
            		{% for col in columns %}
            			"{{ col.name }}" {{ col.dataType }}
            			{%- if not col.nullable %} NOT NULL
            				{%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
            			{% endif %}
            			{%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
            			{%- if not loop.last -%}, {% endif %}
            		{% endfor %}
            	)
            	{%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}


            {% elif node.materializationType == 'view' %}
                {{ stage('Create Stage View') }}

                CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}"
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                AS
                {% for source in sources %}
                    SELECT
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}

                    {% if not loop.last %}
                        {% if config.insertStrategy in ['UNION', 'UNION ALL'] %}
                            {{ config.insertStrategy }}
                        {% else %}
                            UNION
                        {% endif %}
                    {% endif %}
                {% endfor %}

            {% endif %}
        run:
          templateString: |2

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}
            	
            	
            	
            		{% if config.truncateBefore %}
            	
            			{{ stage('Truncate Stage Table') }}
            			TRUNCATE IF EXISTS {{ ref_no_link(node.location.name, node.name) }}
            	
            		{% endif %}
            	
            	
            		{% if config.insertStrategy in ['UNION', 'UNION ALL'] %}
            			{{ stage( config.insertStrategy + ' Sources' | string ) }}
            			INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in columns %}
            						"{{ col.name }}"
            						{%- if not loop.last -%},{% endif %}
            					{% endfor %}
            				)
            		{% endif %}
            	
            	
            		{% for source in sources %}
            	
            			{% if config.insertStrategy == 'INSERT' %}
            				{{ stage('Insert ' + source.name | string ) }}
            	
            				INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            				(
            					{% for col in source.columns %}
            						"{{ col.name }}"
            						{%- if not loop.last -%},{% endif %}
            					{% endfor %}
            				)
            			{% endif %}
            	
            			SELECT
            			{% for col in source.columns %}
                            {{ get_source_transform(col) }} AS "{{ col.name }}"
            				{%- if not loop.last -%}, {% endif %}
            			{% endfor %}
            	
            			{{ source.join }}
            	
            			{% if config.insertStrategy in ['UNION', 'UNION ALL'] and not loop.last %}
            				{{config.insertStrategy}}
            			{% endif %}
            	
            		{% endfor %}
            	
            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
    name: Stage
    version: 1
  StepType-View:
    id: View
    isDisabled: false
    metadata:
      defaultStorageLocation: DWH
      error: null
      nodeMetadataSpec: |
        capitalized: View
        short: V
        tagColor: '#C4C4C4'
        isDisabled: true
        plural: Views

        config:
          - groupName: Options
            items: 
            - type: materializationSelector
              options:
                - view
              default: view
              isRequired: true

            - type: toggleButton
              attributeName: selectDistinct
              displayName: Distinct

            - type: multisourceToggle

            - type: overrideSQLToggle

            - displayName: Multi Source Strategy
              attributeName: insertStrategy
              type: dropdownSelector
              default: UNION
              options:
              - "UNION"
              - "UNION ALL" 
              isRequired: true
              enableIf: "{% if node.isMultisource %} true {% else %} false {% endif %}"
      templates:
        create:
          templateString: |
            {% if node.override.create.enabled %}
                
                {{ node.override.create.script }}

            {% else %}
                {{ stage('Create View') }}
                CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}"
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                AS
                {% for source in sources %}
                    SELECT {% if config.selectDistinct %} DISTINCT {% endif %}
                    {% for col in source.columns %}
                        {{ get_source_transform(col) }} AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}

                    {{ source.join }}

                    {% if not loop.last %}
                        {% if config.insertStrategy in ['UNION', 'UNION ALL'] %}
                            {{ config.insertStrategy }}
                        {% else %}
                            UNION
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        run:
          templateString: ""
    name: View
    version: 1
  StepType-persistentStage:
    id: persistentStage
    isDisabled: true
    metadata:
      defaultStorageLocation: STAGE
      error: null
      nodeMetadataSpec: |
        capitalized: Persistent Stage
        short: PSTG
        plural: Persistent Stages
        tagColor: '#29B2DB'
            
        config:
        - groupName: Options
          items:
          - type: materializationSelector
            isRequired: true
            default: table
            options:
            - table
            - view
          
          - type: businessKeyColumns
            isRequired: false

          - type: multisourceToggle
            enableIf: "{% if node.materializationType == 'table' %} true {% else %} false {% endif %}"

          - type: overrideSQLToggle
            enableIf: "{% if node.materializationType == 'view' %} true {% else %} false {% endif %}"

          - displayName: Enable Tests
            attributeName: testsEnabled
            type: toggleButton
            default: true
            
          - displayName: Pre-SQL
            attributeName: preSQL
            type: textBox
            syntax: sql
            isRequired: false

          - displayName: Post-SQL
            attributeName: postSQL
            type: textBox
            syntax: sql
            isRequired: false

        systemColumns:

        - displayName: '{{NODE_NAME}}_KEY'
          transform: ''
          dataType: NUMBER
          placement: beginning
          attributeName: isSurrogateKey

        - displayName: SYSTEM_VERSION
          transform: ''
          dataType: NUMBER
          placement: end
          attributeName: isSystemVersion

        - displayName: SYSTEM_CURRENT_FLAG
          transform: ''
          dataType: VARCHAR
          placement: end
          attributeName: isSystemCurrentFlag

        - displayName: SYSTEM_START_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemStartDate

        - displayName: SYSTEM_END_DATE
          transform: CAST('2999-12-31 00:00:00' AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemEndDate

        - displayName: SYSTEM_CREATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemCreateDate

        - displayName: SYSTEM_UPDATE_DATE
          transform: CAST(CURRENT_TIMESTAMP AS TIMESTAMP)
          dataType: TIMESTAMP
          placement: end
          attributeName: isSystemUpdateDate
      templates:
        create:
          templateString: |
            {% if node.materializationType == 'table' %}
                {{ stage('Create Persistent Stage Table') }}

                CREATE OR REPLACE TABLE {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}" {{ col.dataType }}
                        {% if col.isSurrogateKey %}
            		        identity
                        {% endif %}
                        {%- if not col.nullable %} NOT NULL
                            {%- if col.defaultValue | length > 0 %} DEFAULT {{ col.defaultValue }}{% endif %}
                        {% endif %}
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}


            {% elif node.materializationType == 'view' %}
                {{ stage('Create Persistent Stage View') }}

                CREATE OR REPLACE VIEW {{ ref_no_link(node.location.name, node.name) }}
                (
                    {% for col in columns %}
                        "{{ col.name }}"
                        {%- if col.description | length > 0 %} COMMENT '{{ col.description | escape }}'{% endif %}
                        {%- if not loop.last -%},{% endif %}
                    {% endfor %}
                )
                {%- if node.description | length > 0 %} COMMENT = '{{ node.description | escape }}'{% endif %}
                AS
                {% for source in sources %}

            		{% if not loop.last %} UNION ALL {% endif %}
            	{% endfor %}

                    {% for col in source.columns %}
                        {% if col.isSurrogateKey or col.isSystemUpdateDate or col.isSystemCreateDate %}
                            NULL
                        {% else %}
                            {{ get_source_transform(col) }}
                        {% endif %}
                        AS "{{ col.name }}"
                        {%- if not loop.last -%}, {% endif %}
                    {% endfor %}
                    {{ source.join }}

            {% endif %}
        run:
          templateString: |-

            {% set has_business_key = columns | selectattr("isBusinessKey") | list | length > 0 %}
            {% set is_type_2 = columns | selectattr("isChangeTracking") | list | length > 0 %}

                {% for test in node.tests if config.testsEnabled %}
                    {% if test.runOrder == 'Before' %}
                        {{ test_stage(test.name, test.continueOnFailure) }}
                        {{ test.templateString }}
                    {% endif %}
                {% endfor %}

            {% if node.materializationType == 'table' %}
            	{% if config.preSQL %}
            		{{ stage('Pre-SQL') }}
            		{{ config.preSQL }}
            	{% endif %}
            	
                {% if has_business_key and is_type_2 %}

                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                        /* New Rows That Don't Exist */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_INITAL_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        LEFT JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                                {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "DIM"."{{ col.name }}" IS NULL
                        {% endfor %}
                        UNION ALL
                        /* New Row Needing To Be Inserted Due To Type-2 Column Changes */
                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion %}
                                "DIM"."{{ col.name }}" + 1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                               {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor %}
                            'INSERT_NEW_VERSION_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Expired Due To Type-2 Column Changes
                        In this case, only two columns are merged (version and end date) */
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemEndDate %}
                                DATEADD(MILLISECONDS, -1, CAST(CURRENT_TIMESTAMP AS TIMESTAMP))
                            {% elif col.isSystemCurrentFlag %}
                                'N'
                            {% else %}
                                "DIM"."{{ col.name }}"
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'update_expired_version_rows' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        {% for col in source.columns if (col.isChangeTracking == true) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            ( NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**') )
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        UNION ALL
                        /* Rows Needing To Be Updated Due To Changes To Non-Type-2 source.columns
                        This case merges only when there are changes in non-type-2 column updates, but no changes in type-2 columns*/
                        SELECT
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            {% if col.isSystemVersion or col.isSystemCreateDate or col.isSystemStartDate or col.isSystemEndDate %}
                                "DIM"."{{ col.name }}"
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                                {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}",
                        {% endfor -%}
                            'UPDATE_NON_TYPE2_ROWS' AS "DML_OPERATION"
                        {{ source.join }}
                        INNER JOIN {{ ref_no_link(node.location.name, node.name) }} "DIM" ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %}
                        WHERE "DIM"."{{ get_value_by_column_attribute("isSystemCurrentFlag") }}" = 'Y'
                        AND (
                        {% for col in source.columns if (col.isChangeTracking) -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            {{ get_source_transform(col) }} = "DIM"."{{ col.name }}"
                        {% endfor %} )
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isChangeTracking or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) -%}
                            {% if loop.first %}
                                AND (
                            {% endif %}
                            {% if not loop.first %}
                                OR
                            {% endif %}
                            NVL( CAST({{ get_source_transform(col) }} as STRING), '**NULL**') <> NVL( CAST("DIM"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                    ) AS "SRC"
                    ON
                    {% for col in source.columns if col.isBusinessKey -%}
                        {% if not loop.first %}
                            AND
                        {% endif %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                    {% endfor %}
                    AND "TGT"."{{ get_value_by_column_attribute("isSystemVersion") }}" = "SRC"."{{ get_value_by_column_attribute("isSystemVersion") }}"
                    WHEN MATCHED THEN UPDATE SET
                    {%- for col in source.columns if not (col.isBusinessKey or col.isSurrogateKey or col.isSystemCreateDate) %}
                        "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    WHEN NOT MATCHED THEN INSERT (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )
                    VALUES (
                    {%- for col in source.columns if not col.isSurrogateKey %}
                        "SRC"."{{ col.name }}"
                        {% if not loop.last %}, {% endif %}
                    {% endfor -%}
                    )

                {% endfor %}

                {% elif has_business_key and not is_type_2 %}
                    {% for source in sources %}
                        {{ stage('MERGE ' + source.name | string ) }}
                        MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT"
                        USING (
                            SELECT
                            {% for col in source.columns if not col.isSurrogateKey %}
                                {% if col.isSystemVersion %}
                                	1
                                {% elif col.isSystemCurrentFlag %}
                                	'Y'
                                {% else %}
                                    {{ get_source_transform(col) }}
                                {% endif %}
                                AS "{{ col.name }}"
                                {%- if not loop.last %}, {% endif %}
                            {% endfor %}
                            {{ source.join }})
                            AS "SRC"
                        ON
                        {% for col in source.columns if col.isBusinessKey -%}
                            {% if not loop.first %}
                                AND
                            {% endif %}
                            "SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
                        {% endfor %}
                        WHEN MATCHED
                        {% for col in source.columns if not (   col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemUpdateDate or
                                                                col.isSystemCreateDate) %}
                            {% if loop.first %}
                                AND (
                            {% else %}
                                OR
                            {% endif %}
                            NVL( CAST("SRC"."{{ col.name }}" as STRING), '**NULL**') <> NVL( CAST("TGT"."{{ col.name }}" as STRING), '**NULL**')
                            {% if loop.last %}
                                )
                            {% endif %}
                        {% endfor %}
                        THEN UPDATE SET
                        {%- for col in source.columns if not (  col.isBusinessKey or
                                                                col.isSurrogateKey or
                                                                col.isSystemVersion or
                                                                col.isSystemCurrentFlag or
                                                                col.isSystemStartDate or
                                                                col.isSystemEndDate or
                                                                col.isSystemCreateDate) %}
                                "TGT"."{{ col.name }}" = "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        WHEN NOT MATCHED THEN
                        INSERT (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                        VALUES (
                        {%- for col in source.columns if not col.isSurrogateKey %}
                            "SRC"."{{ col.name }}"
                            {% if not loop.last %}, {% endif %}
                        {% endfor -%}
                        )
                    {% endfor %}
                {% else %}
                    {% for source in sources %}
                        {{ stage('Insert ' + source.name | string ) }}
                        INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
                        (
                            {% for col in source.columns if not col.isSurrogateKey %}
                                "{{ col.name }}"
                                {%- if not loop.last -%},{% endif %}
                            {% endfor %}
                        )

                        SELECT
                        {% for col in source.columns if not col.isSurrogateKey %}

                            {% if col.isSystemVersion %}
                                1
                            {% elif col.isSystemCurrentFlag %}
                                'Y'
                            {% else %}
                                {{ get_source_transform(col) }}
                            {% endif %}
                            AS "{{ col.name }}"
                            {%- if not loop.last -%}, {% endif %}
                            
                        {% endfor %}
                        {{ source.join }}
                    {% endfor %}            
                {% endif %}
            	
            	{% if config.postSQL %}
            		{{ stage('Post-SQL') }}
            		{{ config.postSQL }}
            	{% endif %}
            	
            {% endif %}

            {% if config.testsEnabled %}
            	{% for test in node.tests %}
            		{% if test.runOrder == 'After' %}
            			{{ test_stage(test.name, test.continueOnFailure) }}
            			{{ test.templateString }}
                    {% endif %}
            	{% endfor %}

            	{% for column in columns %}
            		{% for test in column.tests %}
            			{{ test_stage(column.name + ": " + test.name) }}
            			{{ test.templateString }}
            		{% endfor %}
            	{% endfor %}
            {% endif %}
    name: Persistent Stage
    version: 1
subgraphs:
  Subgraph-105:
    id: "105"
    name: Customer
    steps:
      - 04125dff-891c-466a-b9a1-9e9525426d4a
      - 12be9651-24ba-4f76-9010-dc1f1ebb35a4
      - b5f82f01-75b2-4371-83b2-16ef30b050af
      - df9d3e39-a2eb-4c23-8e93-137ba9daeebd
      - e6c0e051-5b41-4bf5-8606-43329da81810
      - de9ae52e-a9a2-4b2e-bef7-8bbcf27d9754
      - f923ca3e-1b50-42f5-ac34-1e8b5b3015e7
      - b745c923-977d-45b8-9fa1-1ae30477fe35
  Subgraph-118:
    id: "118"
    name: New Subgraph
    steps:
      - 786e9e60-f128-48f9-a556-b87230d890b8
version: 2
