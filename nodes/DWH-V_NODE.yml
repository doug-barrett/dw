steps:
  V_NODE-c95babb8-a79e-4742-9ddb-87514111823f:
    operation:
      config:
        insertStrategy: UNION
        selectDistinct: false
      database: ""
      deployEnabled: true
      description: ""
      isMultisource: false
      locationName: DWH
      materializationType: view
      metadata:
        appliedNodeTests: []
        columns:
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 2e27b29b-b513-45f9-aaea-d7f1478530c8
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: NUMBER(38,0)
            defaultValue: ""
            description: ""
            name: SUPPKEY
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 81a23eaa-8435-41a7-9900-07e120fea316
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: VARCHAR(53)
            defaultValue: ""
            description: ""
            name: SUPP_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 080c8846-8a94-42d5-b812-c74f62432d00
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: VARCHAR(25)
            defaultValue: ""
            description: ""
            name: NATION
            nullable: false
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 8ce92be4-6fdd-42a5-b504-6c45c9243e48
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: NUMBER(38,6)
            defaultValue: ""
            description: ""
            name: TOTAL_SALES
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 1f53ce11-def2-4d95-8cf1-636f7581abb6
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: NUMBER(38,6)
            defaultValue: ""
            description: ""
            name: TOP_SALES
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 4b6d86c2-f422-46b6-a08f-44858e22ba66
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: NUMBER(38,6)
            defaultValue: ""
            description: ""
            name: MID_SALES
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 9eb7be40-bcbb-4486-b55d-e8eb79b59d03
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: NUMBER(38,6)
            defaultValue: ""
            description: ""
            name: BOTTOM_SALES
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
          - acceptedValues:
              strictMatch: true
              values: []
            appliedColumnTests: {}
            columnReference:
              columnCounter: 67c7e049-9a45-4eb5-9454-265c9ae53f19
              stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
            config: {}
            dataType: VARCHAR(16777216)
            defaultValue: ""
            description: ""
            name: TOP_NATIONS
            nullable: false
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
            transform: ""
        cteString: ""
        enabledColumnTestIDs: []
        sourceMapping:
          - aliases: {}
            customSQL:
              customSQL: |-
                {{ stage('Override Create SQL') }}
                	CREATE OR REPLACE VIEW {{ ref('DWH', 'V_NODE')}} AS (
                WITH 
                    sales_year as (
                        SELECT TOP 5 YEAR(O_ORDERDATE) YR
                        FROM {{ref('SRC_SAMPLE','ORDERS')}}
                        GROUP BY YEAR(O_ORDERDATE)
                        ORDER BY YEAR(O_ORDERDATE) DESC
                        )
                    ,sales_base AS (
                        SELECT L.L_SUPPKEY SUPPKEY, N.N_NAME NATION, 
                               SUM(((L.L_EXTENDEDPRICE * L.L_QUANTITY) * (1 - L.L_DISCOUNT))) SALES_AMT
                        FROM {{ref('SRC_SAMPLE','LINEITEM')}} L
                        JOIN {{ref('SRC_SAMPLE','ORDERS')}} O ON L.L_ORDERKEY = O.O_ORDERKEY
                        JOIN {{ref('SRC_SAMPLE','CUSTOMER')}} C ON O.O_CUSTKEY = C.C_CUSTKEY
                        JOIN {{ref('SRC_SAMPLE','NATION')}} N ON C.C_NATIONKEY = N.N_NATIONKEY
                        --LEFT JOIN DOUG_DB.DEV_STG.EXCLUDE_SUPPLIERS E ON L.L_SUPPKEY = E.E_SUPPKEY
                        WHERE --E.E_SUPPKEY IS NULL AND
                          O.O_ORDERSTATUS = 'F'
                         AND YEAR(O.O_ORDERDATE) in (SELECT YR FROM sales_year)
                        GROUP BY SUPPKEY, NATION)
                    ,supplier_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT
                        FROM sales_base
                        GROUP BY SUPPKEY)
                    ,nation_rank as (
                        SELECT SUPPKEY, NATION, SALES_AMT,
                               ROW_NUMBER() OVER (PARTITION BY SUPPKEY ORDER BY SALES_AMT) NATION_RANK,
                               ROW_NUMBER() OVER (PARTITION BY SUPPKEY ORDER BY SALES_AMT DESC) NATION_RANK_REV
                        FROM sales_base)
                    ,top_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) TOP_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK <= 10
                        GROUP BY SUPPKEY)
                    ,mid_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) MID_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK > 10 AND NATION_RANK_REV > 10
                        GROUP BY SUPPKEY)
                    ,bottom_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) BOTTOM_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK_REV <= 10
                        GROUP BY SUPPKEY)
                    ,supplier_details as (
                        SELECT S_SUPPKEY SUPPKEY, S_NAME || ' ('||N_NAME||')' SUPP_NAME, N_NAME NATION
                        FROM {{ref('SRC_SAMPLE','SUPPLIER')}} S
                        JOIN {{ref('SRC_SAMPLE','NATION')}} N ON S.S_NATIONKEY = N.N_NATIONKEY)
                SELECT s.SUPPKEY, s.SUPP_NAME, s.NATION, 
                       total.SALES_AMT TOTAL_SALES, 
                       top.SALES_AMT TOP_SALES,
                       mid.SALES_AMT MID_SALES,
                       bot.SALES_AMT BOTTOM_SALES,
                       top.TOP_NATIONS 
                FROM supplier_details s 
                JOIN supplier_sales total ON s.SUPPKEY = total.SUPPKEY
                JOIN top_nation_sales top ON  s.SUPPKEY = top.SUPPKEY
                JOIN mid_nation_sales mid ON  s.SUPPKEY = mid.SUPPKEY
                JOIN bottom_nation_sales bot ON  s.SUPPKEY = bot.SUPPKEY
                ORDER BY 1
                	)
            dependencies:
              - locationName: SRC_SAMPLE
                nodeName: CUSTOMER
              - locationName: SRC_SAMPLE
                nodeName: LINEITEM
              - locationName: SRC_SAMPLE
                nodeName: NATION
              - locationName: SRC_SAMPLE
                nodeName: ORDERS
              - locationName: SRC_SAMPLE
                nodeName: SUPPLIER
            join:
              joinCondition: |-
                WITH 
                    sales_year as (
                        SELECT TOP 5 YEAR(O_ORDERDATE) YR
                        FROM {{ref('SRC_SAMPLE','ORDERS')}}
                        GROUP BY YEAR(O_ORDERDATE)
                        ORDER BY YEAR(O_ORDERDATE) DESC
                        )
                    ,sales_base AS (
                        SELECT L.L_SUPPKEY SUPPKEY, N.N_NAME NATION, 
                               SUM(((L.L_EXTENDEDPRICE * L.L_QUANTITY) * (1 - L.L_DISCOUNT))) SALES_AMT
                        FROM {{ref('SRC_SAMPLE','LINEITEM')}} L
                        JOIN {{ref('SRC_SAMPLE','ORDERS')}} O ON L.L_ORDERKEY = O.O_ORDERKEY
                        JOIN {{ref('SRC_SAMPLE','CUSTOMER')}} C ON O.O_CUSTKEY = C.C_CUSTKEY
                        JOIN {{ref('SRC_SAMPLE','NATION')}} N ON C.C_NATIONKEY = N.N_NATIONKEY
                        --LEFT JOIN DOUG_DB.DEV_STG.EXCLUDE_SUPPLIERS E ON L.L_SUPPKEY = E.E_SUPPKEY
                        WHERE --E.E_SUPPKEY IS NULL AND
                          O.O_ORDERSTATUS = 'F'
                         AND YEAR(O.O_ORDERDATE) in (SELECT YR FROM sales_year)
                        GROUP BY SUPPKEY, NATION)
                    ,supplier_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT
                        FROM sales_base
                        GROUP BY SUPPKEY)
                    ,nation_rank as (
                        SELECT SUPPKEY, NATION, SALES_AMT,
                               ROW_NUMBER() OVER (PARTITION BY SUPPKEY ORDER BY SALES_AMT) NATION_RANK,
                               ROW_NUMBER() OVER (PARTITION BY SUPPKEY ORDER BY SALES_AMT DESC) NATION_RANK_REV
                        FROM sales_base)
                    ,top_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) TOP_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK <= 10
                        GROUP BY SUPPKEY)
                    ,mid_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) MID_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK > 10 AND NATION_RANK_REV > 10
                        GROUP BY SUPPKEY)
                    ,bottom_nation_sales as (
                        SELECT SUPPKEY, SUM(SALES_AMT) SALES_AMT, LISTAGG(NATION, ',') WITHIN GROUP (ORDER BY NATION_RANK) BOTTOM_NATIONS
                        FROM nation_rank
                        WHERE NATION_RANK_REV <= 10
                        GROUP BY SUPPKEY)
                    ,supplier_details as (
                        SELECT S_SUPPKEY SUPPKEY, S_NAME || ' ('||N_NAME||')' SUPP_NAME, N_NAME NATION
                        FROM {{ref('SRC_SAMPLE','SUPPLIER')}} S
                        JOIN {{ref('SRC_SAMPLE','NATION')}} N ON S.S_NATIONKEY = N.N_NATIONKEY)
                SELECT s.SUPPKEY, s.SUPP_NAME, s.NATION, 
                       total.SALES_AMT TOTAL_SALES, 
                       top.SALES_AMT TOP_SALES,
                       mid.SALES_AMT MID_SALES,
                       bot.SALES_AMT BOTTOM_SALES,
                       top.TOP_NATIONS 
                FROM supplier_details s 
                JOIN supplier_sales total ON s.SUPPKEY = total.SUPPKEY
                JOIN top_nation_sales top ON  s.SUPPKEY = top.SUPPKEY
                JOIN mid_nation_sales mid ON  s.SUPPKEY = mid.SUPPKEY
                JOIN bottom_nation_sales bot ON  s.SUPPKEY = bot.SUPPKEY
                ORDER BY 1
            name: V_NODE
            noLinkRefs: []
      name: V_NODE
      overrideSQL: true
      schema: ""
      sqlType: View
      type: sql
    stepCounter: c95babb8-a79e-4742-9ddb-87514111823f
